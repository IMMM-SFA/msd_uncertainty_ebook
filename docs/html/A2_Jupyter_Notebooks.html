
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2. Jupyter Notebook Tutorials &#8212; Addressing Uncertainty in MultiSector Dynamics Research  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=0a66277c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'A2_Jupyter_Notebooks';</script>
    <script src="_static/custom.js?v=d380ae45"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Plotting Code Samples" href="A3_plotting_code.html" />
    <link rel="prev" title="1. Uncertainty Quantification" href="A1_Uncertainty_Quantification.html" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z9WMRS23CZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z9WMRS23CZ');
</script>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Addressing Uncertainty in MultiSector Dynamics Research  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="citation.html">Suggested Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contribution Guide</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1_introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_diagnostic_modeling_overview_and_perspectives.html">2. Diagnostic Modeling Overview and Perspectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_sensitivity_analysis_the_basics.html">3. Sensitivity Analysis: The Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_sensitivity_analysis_diagnostic_and_exploratory_modeling.html">4. Sensitivity Analysis: Diagnostic &amp; Exploratory Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_conclusion.html">5. Conclusion</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="A1_Uncertainty_Quantification.html">A. Uncertainty Quantification</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">B. Jupyter Notebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="A3_plotting_code.html">C. Plotting Code Samples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="6_glossary.html">Glossary</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R.Bibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/IMMM-SFA/msd_uncertainty_ebook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/issues/new?title=Issue%20on%20page%20%2FA2_Jupyter_Notebooks.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/A2_Jupyter_Notebooks.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Jupyter Notebook Tutorials</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fishery-dynamics-tutorial">B.1. Fishery Dynamics Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-sensitivity-analysis-sa-to-discover-factors-shaping-consequential-dynamics">B.1.1. Tutorial: Sensitivity Analysis (SA) to discover factors shaping consequential dynamics</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lets-get-started">B.1.1.1. Let’s get started!</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-load-identified-solutions-and-explore-performance">B.1.1.2. Step 1: Load identified solutions and explore performance</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-use-salib-to-generate-a-sample-for-a-sobol-sensitivity-analysis">B.1.1.3. Step 2: Use SALib to generate a sample for a Sobol sensitivity analysis</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-evaluate-the-system-over-all-generated-states-of-the-world">B.1.1.4. Step 3: Evaluate the system over all generated states of the world</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-calculate-sensitivity-indices">B.1.1.5. Step 4: Calculate sensitivity indices</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-explore-relationship-between-uncertain-factors-and-performance">B.1.1.6. Step 5: Explore relationship between uncertain factors and performance</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-sobol-sa-and-scenario-discovery-to-your-problem">B.1.1.7. Tips to Apply Sobol SA and Scenario Discovery to your Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sobol-sa-tutorial">B.2. Sobol SA Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-sensitivity-analysis-sa-using-the-saltelli-sampling-scheme-with-sobol-sa">B.2.1. Tutorial: Sensitivity Analysis (SA) using the Saltelli sampling scheme with Sobol SA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">B.2.1.1. Let’s get started!</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-generate-the-problem-dictionary">B.2.1.2. Step 1: Generate the problem dictionary</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-generate-samples-using-the-saltelli-sampling-scheme">B.2.1.3. Step 2: Generate samples using the Saltelli sampling scheme</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-execute-the-ishigami-function-over-our-sample-set">B.2.1.4. Step 3: Execute the Ishigami function over our sample set</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-compute-first-second-and-total-order-sensitivity-indices-using-the-sobol-method">B.2.1.5. Step 4: Compute first-, second-, and total-order sensitivity indices using the Sobol method</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-interpret-our-results">B.2.1.6. Step 5: Interpret our results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-sobol-sa-to-your-own-problem">B.2.1.7. Tips to Apply Sobol SA to Your Own Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-tutorial">B.3. Logistic Regression Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-logistic-regression-for-factor-mapping">B.3.1. Tutorial: Logistic Regression for Factor Mapping</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#background">B.3.1.1. Background</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">B.3.1.2. Let’s get started!</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-load-latin-hypercube-sample-and-set-up-problem">B.3.1.3. Step 1: Load Latin hypercube sample and set up problem</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-define-decision-relevant-metrics-for-illustration">B.3.1.4. Step 2: Define decision-relevant metrics for illustration</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-run-the-logistic-regression">B.3.1.5. Step 3: Run the logistic regression</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-factor-ranking">B.3.1.6. Step 4: Factor ranking</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-draw-factor-maps">B.3.1.7. Step 5: Draw factor maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-scenario-discovery-to-your-own-problem">B.3.1.8. Tips to Apply Scenario Discovery to Your Own Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hymod-dynamics-tutorial">B.4. HYMOD Dynamics Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-sensitivity-analysis-of-the-hymod-model">B.4.1. Tutorial: Sensitivity Analysis of the HYMOD Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-hymod">B.4.2. 1 - Introduction to HYMOD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-sensitivity-analysis">B.4.3. 2- Global Sensitivity Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-this-methodology-to-your-own-problem">B.4.4. Tips to Apply this methodology to your own problem</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#time-evolving-scenario-discovery-for-infrastructure-pathways">B.5. Time-evolving scenario discovery for infrastructure pathways</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">B.5.1. Time-evolving scenario discovery for infrastructure pathways</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">B.5.1.1. Background</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-robustness-over-time">B.5.1.2. Evaluating Robustness over time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-performance-evolution">B.5.1.3. Exploring performance evolution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-deep-uncertainties-generate-vulnerability">B.5.1.4. How do deep uncertainties generate vulnerability</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#which-uncertainties-have-the-most-influence-on-time-evolving-performance">B.5.1.5. Which uncertainties have the most influence on time-evolving performance?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#open-exploration">B.5.1.6. Open exploration</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">B.5.1.7. Tips to apply this methodology to your own problem</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#references">B.5.1.8. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios-tutorial">B.6. A Hidden-Markov Modeling Approach to Creating Synthetic Streamflow Scenarios Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios">B.6.1. A Hidden-Markov Modeling Approach to Creating Synthetic Streamflow Scenarios</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">B.6.1.1. Background</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">B.6.2. Let’s Get Started!</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#observed-record">B.6.2.1. Observed Record</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-stationary-generator-to-better-quantify-natural-variability">B.6.2.2. Synthetic Stationary Generator to Better Quantify Natural Variability</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#non-stationary-synthetic-generator-to-impose-climate-changes">B.6.2.3. Non-Stationary Synthetic Generator to Impose Climate Changes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#placing-cmip5-projections-in-the-context-of-non-stationary-flows">B.6.2.4. Placing CMIP5 Projections in the Context of Non-Stationary Flows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-create-an-hmm-based-generator-for-your-system">B.6.2.5. Tips to Create an HMM-Based Generator for your System</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">B.6.2.6. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-calibration-with-markov-chain-monte-carlo-tutorial">B.7. Model Calibration with Markov chain Monte Carlo Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-calibration-with-markov-chain-monte-carlo">B.7.1. Model Calibration with Markov chain Monte Carlo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mcmc-for-model-calibration-and-uncertainty-quantification">B.7.1.1. MCMC for Model Calibration and Uncertainty Quantification</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-uncertainty-quantification">Bayesian Uncertainty Quantification</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#rejection-sampling">Rejection Sampling</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#markov-chain-monte-carlo">Markov chain Monte Carlo</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hymod-calibration">B.7.1.2. HYMOD Calibration</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-distributions">Prior Distributions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#metropolis-hastings">Metropolis-Hastings</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#challenges-and-next-steps">B.7.1.3. Challenges and Next Steps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-for-using-mcmc">B.7.1.4. Tips for Using MCMC</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="jupyter-notebook-tutorials">
<span id="a2-jupyter-notebooks"></span><h1><span class="section-number">B. </span>Jupyter Notebook Tutorials<a class="headerlink" href="#jupyter-notebook-tutorials" title="Link to this heading">#</a></h1>
<section id="fishery-dynamics-tutorial">
<h2><span class="section-number">B.1. </span>Fishery Dynamics Tutorial<a class="headerlink" href="#fishery-dynamics-tutorial" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/fishery_dynamics.ipynb">Fishery Dynamics Notebook</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<section id="tutorial-sensitivity-analysis-sa-to-discover-factors-shaping-consequential-dynamics">
<h3><span class="section-number">B.1.1. </span>Tutorial: Sensitivity Analysis (SA) to discover factors shaping consequential dynamics<a class="headerlink" href="#tutorial-sensitivity-analysis-sa-to-discover-factors-shaping-consequential-dynamics" title="Link to this heading">#</a></h3>
<p>This notebook demonstrates the application of sensitivity analysis to
discover factors that shape the behavior modes of a socio-ecological
system with dynamic human action.</p>
<p>The system of differential equations below represent a system of prey
(defined in the equation below as x) and predator (defined as y) fish,
with a human actor harvesting the prey fish. You can read more about
this system at <a class="reference external" href="https://doi.org/10.1155/2020/4170453">Hadjimichael et
al. (2020)</a>.</p>
<img alt="_images/eqn2.png" src="_images/eqn2.png" />
<p>The table below defines the parameters in the system and also denotes
the baseline and ranges associated with each uncertain parameter.</p>
<img alt="_images/table1.png" src="_images/table1.png" />
<p>The system is simple but very rich in the dynamic behaviors it exhibits.
This complexity is accompanied by the presence of several equilibria
that come in and out of existence with different parameter values. The
equilibria also change in their stability according to different
parameter values, giving rise to different behavior modes as shown by
the diverse predator and prey abundace trajectories in the figure below.</p>
<img alt="_images/Figure_1.png" src="_images/Figure_1.png" />
<p>In the unharvested system (without the human actor) the stability of
several of these equilibria can be derived analytically. The task
becomes significantly more difficult when the adaptive human actor is
introduced, deciding to harvest the system at different rates according
to their objectives and preferences.</p>
<p>Sensitivity analysis methods can help us identify the factors that most
control these dynamics by exploring the space of parameter values and
seeing how system outputs change as a result.</p>
<p>Through previously conducted optimization, there already exists a set of
potential harvesting strategies that were identified in pursuit of five
objectives:</p>
<ul class="simple">
<li><p>Maximize Harvesting Discounted Profits (Net Present Value)</p></li>
<li><p>Minimize Prey Population Deficit</p></li>
<li><p>Minimize Longest Duration of Consecutive Low Harvest</p></li>
<li><p>Maximize Worst Harvest Instance</p></li>
<li><p>Minimize Harvest Variance</p></li>
</ul>
<p>The identified harvesting strategies also meet the necessary constraint
of not causing inadvertent predator collapse.</p>
<p>We will be examining the effects of parametric uncertainty on these
identified strategies, particularly focusing on two strategies: one
selected to maximize harvesting profits and one identified through
previous analysis to perform ‘well enough’ for all objectives across a
wide range of states of the world (referred to as the ‘robust’
harvesting policy).</p>
<section id="lets-get-started">
<h4><span class="section-number">B.1.1.1. </span>Let’s get started!<a class="headerlink" href="#lets-get-started" title="Link to this heading">#</a></h4>
<p>In this tutorial, we will be loading in data that has been produced in
Hadjimichael et al. (2020). Before we start our analysis, we’ll load the
relevant Python libraries.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import necessary libraries</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">msdbook</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SALib.sample</span><span class="w"> </span><span class="kn">import</span> <span class="n">saltelli</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SALib.analyze</span><span class="w"> </span><span class="kn">import</span> <span class="n">sobol</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">patheffects</span> <span class="k">as</span> <span class="n">pe</span>

<span class="c1"># load example data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.install_supplement</span><span class="w"> </span><span class="kn">import</span> <span class="n">install_package_data</span>
<span class="n">install_package_data</span><span class="p">()</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.print_figure_kwargs = {&#39;bbox_inches&#39;:None}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Downloading</span> <span class="n">example</span> <span class="n">data</span> <span class="k">for</span> <span class="n">msdbook</span> <span class="n">version</span> <span class="mf">0.1.5</span><span class="o">...</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">uncertain_params_bounds</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_metric_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_vary_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_mth_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">solutions</span><span class="o">.</span><span class="n">resultfile</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3704614</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">LHsamples_original_1000</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3704614</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">param_values</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_yr_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_mth_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7000550</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">collapse_days</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">hymod_params_256samples</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_vary_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7000550</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7200799</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_yr_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7200799</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">LeafCatch</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">hymod_simulations_256samples</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Robustness</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</section>
<section id="step-1-load-identified-solutions-and-explore-performance">
<h4><span class="section-number">B.1.1.2. </span>Step 1: Load identified solutions and explore performance<a class="headerlink" href="#step-1-load-identified-solutions-and-explore-performance" title="Link to this heading">#</a></h4>
<p>Here we load in the solution set obtained in Hadjimichael et al. (2020).
The solution set contains the decision variables and objectives
associated with a variety of harvesting policies. For this tutorial, we
focus on comparing two policies: harvesting profits and one that
performs robustly across all objectives. Below, we are reading in the
decision variables and objectives from an external file that can be
found within the msdbook package data.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robustness</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_robustness_data</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_profit_maximization_data</span><span class="p">()</span>

<span class="n">robust_solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">robustness</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#pick robust solution</span>
<span class="n">profit_solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">6</span><span class="p">])</span> <span class="c1">#pick profitable solution</span>
<span class="n">objective_performance</span> <span class="o">=</span> <span class="o">-</span><span class="n">results</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="c1">#Retain objective values</span>

<span class="c1"># Get decision variables for each of the policies</span>
<span class="n">highprofitpolicy</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">profit_solution</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
<span class="n">mostrobustpolicy</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">robust_solution</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
<p>Next we plot the identified solutions with regards to their objective
performance in a parallel axis plot</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-objective-performance">plot_objective_performance</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">plot_objective_performance</span><span class="p">(</span><span class="n">objective_performance</span><span class="p">,</span> <span class="n">profit_solution</span><span class="p">,</span> <span class="n">robust_solution</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/fishery_output_6_0.png" src="_images/fishery_output_6_0.png" />
<p>The solution set from the optimization in Hadjimichael et al. (2020) are
presented in a parallel axis plot where each of the five objectives (and
one constraint) are represented as an axis. Each solution on the Pareto
front is represented as a line where the color of the line indicates the
value of the NPV objective. The preference for objective values is in
the upward direction. Therefore, the ideal solution would be a line
straight across the top of the plot that satisfies every objective.
However, no such line exists because there are tradeoffs when sets of
objectives are prioritized over the others. When lines cross in between
axes, this indicates a tradeoff between objectives (as seen in the first
two axes).The solution that is most robust in the NPV objective has the
highest value on the first axis and is outlined in dark gold. The
solution that is most robust across all objectives is outlined in a
brighter yellow. A parallel axis is an effective visual to characterize
high-dimensional tradeoffs in the system and visualize differences in
performance across policies.</p>
</section>
<section id="step-2-use-salib-to-generate-a-sample-for-a-sobol-sensitivity-analysis">
<h4><span class="section-number">B.1.1.3. </span>Step 2: Use SALib to generate a sample for a Sobol sensitivity analysis<a class="headerlink" href="#step-2-use-salib-to-generate-a-sample-for-a-sobol-sensitivity-analysis" title="Link to this heading">#</a></h4>
<p>In Step 1, we showed how the optimized harvesting policies performed in
the objective space, which utilized the baseline parameters outlined in
the table above. Now, we are interested in understanding how sensitive
our two policies are to alternative states of the world that may be
characterized by different parameter values. To do so, we first need to
define the problem dictionary that allows us to generate these
alternative states of the world.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up SALib problem</span>
<span class="n">problem</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;num_vars&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
  <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmaX&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmaY&#39;</span><span class="p">],</span>
  <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.002</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5000</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then we use the following command to generate a Saltelli sample from
these defined ranges:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_values</span> <span class="o">=</span> <span class="n">saltelli</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">calc_second_order</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Generally, it is a good idea to save the result of the sample since it
is often reused and regenerating it produces a different sample set. For
this reason, we will load one from file that was previously generated.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load previously generated Saltelli sample from our msdbook package data</span>
<span class="n">param_values</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_saltelli_param_values</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="step-3-evaluate-the-system-over-all-generated-states-of-the-world">
<h4><span class="section-number">B.1.1.4. </span>Step 3: Evaluate the system over all generated states of the world<a class="headerlink" href="#step-3-evaluate-the-system-over-all-generated-states-of-the-world" title="Link to this heading">#</a></h4>
<p>Now we re-evaluate how well the policies do in the new states of the
world. In order to characterize failure of a policy, we identify the
states where the predator population collapses, as an inadvertent
consequence of applying the harvesting strategy under a state of the
world different from the one originally assumed. Due to how long this
step takes to execute within the tutorial, we will read in the solutions
from an external file. However, the block of code below shows how
evaluation can be implemented.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create array to store collapse values under both policies</span>
<span class="n">collapse_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">param_values</span><span class="p">),</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># evaluate performance under every state</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_values</span><span class="p">)):</span>

    <span class="n">additional_inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Previous_Prey&#39;</span><span class="p">],</span>
                                  <span class="p">[</span><span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span>
                                   <span class="n">param_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">]])</span>

    <span class="n">collapse_days</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">fish_game</span><span class="p">(</span><span class="n">highprofitpolicy</span><span class="p">,</span> <span class="n">additional_inputs</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">collapse_days</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">fish_game</span><span class="p">(</span><span class="n">mostrobustpolicy</span><span class="p">,</span> <span class="n">additional_inputs</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the simulation data from our msdbook package data</span>
<span class="n">collapse_days</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_collapse_data</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="step-4-calculate-sensitivity-indices">
<h4><span class="section-number">B.1.1.5. </span>Step 4: Calculate sensitivity indices<a class="headerlink" href="#step-4-calculate-sensitivity-indices" title="Link to this heading">#</a></h4>
<p>Now we use a Sobol sensitivity analysis to calculate first-order,
second-order, and total-order sensitivity indices for each parameter and
for each of the two policies. These indicies help determine which
factors explain the most variability in the number of days of predator
population collapse.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Perform the Sobol SA for the profit-maximizing solution</span>
<span class="n">Si_profit</span> <span class="o">=</span> <span class="n">sobol</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">collapse_days</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                          <span class="n">calc_second_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">conf_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                          <span class="n">print_to_console</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Perform the Sobol SA for the robust solution</span>
<span class="n">Si_robustness</span> <span class="o">=</span> <span class="n">sobol</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span>
                              <span class="n">collapse_days</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="n">calc_second_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">conf_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                              <span class="n">print_to_console</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>              <span class="n">ST</span>   <span class="n">ST_conf</span>
<span class="n">a</span>       <span class="mf">0.226402</span>  <span class="mf">0.036146</span>
<span class="n">b</span>       <span class="mf">0.066819</span>  <span class="mf">0.013347</span>
<span class="n">c</span>       <span class="mf">0.004395</span>  <span class="mf">0.004023</span>
<span class="n">d</span>       <span class="mf">0.024509</span>  <span class="mf">0.006993</span>
<span class="n">h</span>       <span class="mf">0.009765</span>  <span class="mf">0.005488</span>
<span class="n">K</span>       <span class="mf">0.020625</span>  <span class="mf">0.009494</span>
<span class="n">m</span>       <span class="mf">0.897971</span>  <span class="mf">0.066470</span>
<span class="n">sigmaX</span>  <span class="mf">0.000136</span>  <span class="mf">0.000149</span>
<span class="n">sigmaY</span>  <span class="mf">0.000739</span>  <span class="mf">0.001040</span>
              <span class="n">S1</span>   <span class="n">S1_conf</span>
<span class="n">a</span>       <span class="mf">0.087936</span>  <span class="mf">0.044236</span>
<span class="n">b</span>       <span class="mf">0.000554</span>  <span class="mf">0.021474</span>
<span class="n">c</span>      <span class="o">-</span><span class="mf">0.002970</span>  <span class="mf">0.004590</span>
<span class="n">d</span>       <span class="mf">0.001206</span>  <span class="mf">0.015881</span>
<span class="n">h</span>       <span class="mf">0.004554</span>  <span class="mf">0.007998</span>
<span class="n">K</span>       <span class="mf">0.003843</span>  <span class="mf">0.012661</span>
<span class="n">m</span>       <span class="mf">0.751301</span>  <span class="mf">0.071862</span>
<span class="n">sigmaX</span> <span class="o">-</span><span class="mf">0.000325</span>  <span class="mf">0.001245</span>
<span class="n">sigmaY</span> <span class="o">-</span><span class="mf">0.001887</span>  <span class="mf">0.002768</span>
</pre></div>
</div>
<p>Looking at the total-order indices, (ST) factors <span class="math notranslate nohighlight">\(m\)</span>, <span class="math notranslate nohighlight">\(a\)</span>,
<span class="math notranslate nohighlight">\(b\)</span>, <span class="math notranslate nohighlight">\(d\)</span> and <span class="math notranslate nohighlight">\(K\)</span> explain a non-negligible amount of
variance therefore have an effect on the stability of this system.
Looking at the first-order indices (S1), we also see that besides
factors <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(a\)</span>, all other factors are important in this
system through their interactions, which make up the difference between
their S1 and ST indices. This shows the danger of limiting sensitivity
analyses to first order effects, as factor importance might be
significantly misjudged.</p>
<p>These findings are supported by the analytical condition of equilibrium
stability in this system:</p>
<img alt="_images/eqn4.png" src="_images/eqn4.png" />
<p>In an unharvested system, this condition is both necessary and
sufficient for the equilibrium of the two species coexisting to be
stable.</p>
<p>When adaptive human action is introduced however, this condition is
still necessary, but no longer sufficient, as harvesting reduces the
numbers of prey fish and as a result reduces the resources for the
predator fish. Since this harvesting value is not constant, but can
dynamically adapt according to the harvester’s objectives, it cannot be
introduced into this simple equation.</p>
</section>
<section id="step-5-explore-relationship-between-uncertain-factors-and-performance">
<h4><span class="section-number">B.1.1.6. </span>Step 5: Explore relationship between uncertain factors and performance<a class="headerlink" href="#step-5-explore-relationship-between-uncertain-factors-and-performance" title="Link to this heading">#</a></h4>
<p>In the following steps, we will use the results of our sensitivity
analysis to investigate the relationships between parametric
uncertainty, equilibrium stability and the performance of the two
policies.</p>
<p>We can use the top three factors identified (<span class="math notranslate nohighlight">\(m\)</span>, <span class="math notranslate nohighlight">\(a\)</span>, and
<span class="math notranslate nohighlight">\(b\)</span>) to visualize the performance of our policies in this
three-dimensional parametric space.</p>
<p>We first define the stability condition, as a function of <span class="math notranslate nohighlight">\(b\)</span> and
<span class="math notranslate nohighlight">\(m\)</span>, and calculate the corresponding values of <span class="math notranslate nohighlight">\(a\)</span>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">inequality</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">b</span><span class="o">**</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">K</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="p">))</span>

<span class="c1"># boundary interval that separates successful and failed states of the world</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">b</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">inequality</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-factor-performance">plot_factor_performance</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate plot</span>
<span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">plot_factor_performance</span><span class="p">(</span><span class="n">param_values</span><span class="p">,</span> <span class="n">collapse_days</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/fishery_output_22_0.png" src="_images/fishery_output_22_0.png" />
<p>These figures show the combinations of factors that lead to success or
failure in different states of the world for the profit-maximizing and
robust policies. Each point is a state of the world, characterized by
specific values of the parameters, and ideally, we would like the color
of the point to be blue, to represent that there are a low number of
days with a predator collapse in that world. The gray curve denotes the
highly non-linear nature of the boundary, defined by the stability
condition, that separates successful and failed states of the world. The
figures demonstrate the following key points:</p>
<p>First, as asserted above, the policies interact with the system in
different and complex ways. In the presence of human action, the
stability condition is not sufficient in determining whether the policy
will succeed, even though it clearly shapes the system in a fundamental
manner.</p>
<p>Secondly, the robust policy manages to avoid collapse in many more of the sampled states of the world, indicated by the number of blue points. The robust policy avoids collapse in 31% of worlds versus 14% in the profit-maximizing policy.This presents a clear tradeoff between profit-maximizing performance androbustness against uncertainty.</p>
</section>
<section id="tips-to-apply-sobol-sa-and-scenario-discovery-to-your-problem">
<h4><span class="section-number">B.1.1.7. </span>Tips to Apply Sobol SA and Scenario Discovery to your Problem<a class="headerlink" href="#tips-to-apply-sobol-sa-and-scenario-discovery-to-your-problem" title="Link to this heading">#</a></h4>
<p>In this tutorial, we demonstrated a Sobol SA to identify the most
important factors driving the behavior of a system (i.e. the number of
the collapse days). In order to apply this methodology to your problem,
you will need to have a set of optimized policies for your system that
you are interested in analyzing. The general workflow is as follows:</p>
<ol class="arabic simple">
<li><p>Choose sampling bounds for your parameters and set up the problem
dictionary as in Step 2 above.</p></li>
<li><p>Generate samples, or alternative states of the world using the
<code class="docutils literal notranslate"><span class="pre">saltelli.sample</span></code> function.</p></li>
<li><p>Evaluate your policies on the alternative states of the world. For
your application, you will also need to develop a rule for
determining success or failure of your policy in a new SOW. In this
tutorial, success was denoted by a small number of collapse days.
Ultimately, the rule will be specific to your application and can
include various satisficing criteria.</p></li>
<li><p>Calculate the Sobol indices and discover the most important
parameters driving success and failure.</p></li>
<li><p>Finally, use a similar plotting procedure as in step 5 to identify
the combination of parameter values that lead to success and failure
in the system.</p></li>
</ol>
</section>
</section>
</section>
<section id="sobol-sa-tutorial">
<h2><span class="section-number">B.2. </span>Sobol SA Tutorial<a class="headerlink" href="#sobol-sa-tutorial" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/sa_saltelli_sobol_ishigami.ipynb">Sobol SA Tutorial</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<section id="tutorial-sensitivity-analysis-sa-using-the-saltelli-sampling-scheme-with-sobol-sa">
<h3><span class="section-number">B.2.1. </span>Tutorial: Sensitivity Analysis (SA) using the Saltelli sampling scheme with Sobol SA<a class="headerlink" href="#tutorial-sensitivity-analysis-sa-using-the-saltelli-sampling-scheme-with-sobol-sa" title="Link to this heading">#</a></h3>
<p>In this tutorial, we will set up a workflow to investigate how sensitive
the output of a function is to its inputs. Why might you want to do
this? Imagine that this function represents a complex system, such as
the rainfall-runoff process of a watershed model, and that you, the
researcher, want to investigate how your choice of input parameter
values are affecting the model’s characterization of runoff in the
watershed. Your parameter values are likely uncertain and can take on
any value in a pre-defined range. Using a Sobol SA will allow you to
sample different values of your parameters and calculate how sensitive
your output of interest is to certain parameters. Below, we demonstrate
Sobol SA for a simple function to illustrate the method, but the
workflow can be applied to your own problem of interest!</p>
<p>In order to conduct this analysis, we will use the popular Python
Sensitivity Analysis Library
(<a class="reference external" href="https://salib.readthedocs.io/en/latest/index.html">SALib</a>) to:</p>
<ol class="arabic simple">
<li><p>Generate a problem set as a dictionary for our Ishigami function that has three inputs</p></li>
<li><p>Generate 2048 samples for our problem set using the Saltelli <a class="footnote-reference brackets" href="#id10" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#id11" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> sampling scheme</p></li>
<li><p>Execute the Ishigami function for each of our samples and gather the outputs</p></li>
<li><p>Compute the sensitivity analysis to generate first-order and total-order sensitivity indices using the Sobol <a class="footnote-reference brackets" href="#id12" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> method</p></li>
<li><p>Interpret the meaning of our results</p></li>
</ol>
<section id="id6">
<h4><span class="section-number">B.2.1.1. </span>Let’s get started!<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<p><strong>NOTE</strong>: Content from this tutorial is taken directly from the SALib
<a class="reference external" href="https://salib.readthedocs.io/en/latest/basics.html">“Basics”</a>
walkthrough.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import relevant libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">SALib.sample.sobol</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sobol_sample</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SALib.analyze</span><span class="w"> </span><span class="kn">import</span> <span class="n">sobol</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SALib.test_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ishigami</span>
</pre></div>
</div>
</section>
<section id="step-1-generate-the-problem-dictionary">
<h4><span class="section-number">B.2.1.2. </span>Step 1: Generate the problem dictionary<a class="headerlink" href="#step-1-generate-the-problem-dictionary" title="Link to this heading">#</a></h4>
<p>The Ishigami function is of the form:</p>
<div class="math notranslate nohighlight">
\[f(x_1,x_2,x_3) = sin(x_1)+asin^2(x_2)+bx_3^4sin(x_1)\]</div>
<p>The function has three inputs, 𝑥1, 𝑥2, 𝑥3 where 𝑥𝑖 ∈ [−𝜋, 𝜋]. The
constants <span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(b\)</span> are defined as 7.0 and 0.1
respectively.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create a problem dictionary. Here we supply the number of variables, the names of each variable, and the bounds of the variables.</span>
<span class="n">problem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_vars&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="s1">&#39;x3&#39;</span><span class="p">],</span>
    <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="o">-</span><span class="mf">3.14159265359</span><span class="p">,</span> <span class="mf">3.14159265359</span><span class="p">],</span>
               <span class="p">[</span><span class="o">-</span><span class="mf">3.14159265359</span><span class="p">,</span> <span class="mf">3.14159265359</span><span class="p">],</span>
               <span class="p">[</span><span class="o">-</span><span class="mf">3.14159265359</span><span class="p">,</span> <span class="mf">3.14159265359</span><span class="p">]]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step-2-generate-samples-using-the-saltelli-sampling-scheme">
<h4><span class="section-number">B.2.1.3. </span>Step 2: Generate samples using the Saltelli sampling scheme<a class="headerlink" href="#step-2-generate-samples-using-the-saltelli-sampling-scheme" title="Link to this heading">#</a></h4>
<p>Sobol SA requires the use of the Saltelli sampling scheme. The output of
the <code class="docutils literal notranslate"><span class="pre">saltelli.sample</span></code> function is a NumPy array that is of shape 2048
by 3. The sampler generates 𝑁∗(2𝐷+2) samples, where in this example, N
is 256 (the argument we supplied) and D is 3 (the number of model
inputs), yielding 2048 samples. The keyword argument
<code class="docutils literal notranslate"><span class="pre">calc_second_order=False</span></code> will exclude second-order indices, resulting
in a smaller sample matrix with 𝑁∗(𝐷+2) rows instead. Below, we plot the
resulting Saltelli sample.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate parmeter values using the saltelli.sample function</span>
<span class="n">param_values</span> <span class="o">=</span> <span class="n">sobol_sample</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`param_values` shape:  </span><span class="si">{</span><span class="n">param_values</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block"><cite>param_values</cite> shape:  (2048, 3)</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the 2048 samples of the parameters</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span> <span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter3D</span><span class="p">(</span><span class="n">param_values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">param_values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X1 Parameter&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;X2 Parameter&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;X3 Parameter&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Saltelli Sample of Parameter Values&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/output_7_0.png" src="_images/output_7_0.png" />
</section>
<section id="step-3-execute-the-ishigami-function-over-our-sample-set">
<h4><span class="section-number">B.2.1.4. </span>Step 3: Execute the Ishigami function over our sample set<a class="headerlink" href="#step-3-execute-the-ishigami-function-over-our-sample-set" title="Link to this heading">#</a></h4>
<p>SALib provides a nice wrapper to the Ishigami function that allows the
user to directly pass the <code class="docutils literal notranslate"><span class="pre">param_values</span></code> array we just generated into
the function directly.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">Ishigami</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">param_values</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-4-compute-first-second-and-total-order-sensitivity-indices-using-the-sobol-method">
<h4><span class="section-number">B.2.1.5. </span>Step 4: Compute first-, second-, and total-order sensitivity indices using the Sobol method<a class="headerlink" href="#step-4-compute-first-second-and-total-order-sensitivity-indices-using-the-sobol-method" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">sobol.analyze</span></code> function will use our problem dictionary and the
result of the Ishigami runs (<code class="docutils literal notranslate"><span class="pre">Y</span></code>) to compute first-, second-, and
total-order indicies.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Si</span> <span class="o">=</span> <span class="n">sobol</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Si</span></code> is a Python dict with the keys “S1”, “S2”, “ST”, “S1_conf”,
“S2_conf”, and “ST_conf”. The <code class="docutils literal notranslate"><span class="pre">_conf</span></code> keys store the corresponding
confidence intervals, typically with a confidence level of 95%. Use the
keyword argument <code class="docutils literal notranslate"><span class="pre">print_to_console=True</span></code> to print all indices. Or, we
can print the individual values from <code class="docutils literal notranslate"><span class="pre">Si</span></code> as shown in the next step.</p>
</section>
<section id="step-5-interpret-our-results">
<h4><span class="section-number">B.2.1.6. </span>Step 5: Interpret our results<a class="headerlink" href="#step-5-interpret-our-results" title="Link to this heading">#</a></h4>
<p>We execute the following code and take a look at our first-order indices
(<code class="docutils literal notranslate"><span class="pre">S1</span></code>) for each of our three inputs. These indicies can be interpreted
as the fraction of variance in the output that is explained by each
input individually.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_order</span> <span class="o">=</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First-order:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="n">first_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, x2: </span><span class="si">{</span><span class="n">first_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, x3: </span><span class="si">{</span><span class="n">first_order</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">First</span><span class="o">-</span><span class="n">order</span><span class="p">:</span>
<span class="n">x1</span><span class="p">:</span> <span class="mf">0.3184242969763115</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="mf">0.4303808201623416</span><span class="p">,</span> <span class="n">x3</span><span class="p">:</span> <span class="mf">0.022687722804980225</span>
</pre></div>
</div>
<p>If we were to rank the importance of the inputs in how much they
individually explain the variance in the output, we would rank them from
greatest to least importance as follows: 𝑥2, 𝑥1 and then 𝑥3. Since 𝑥3
only explains 2% of the output variance, it does not explain output
variability meaningfully. Thus, this indicates that there is
contribution to the output variance by 𝑥2 and 𝑥1 independently, whereas
𝑥3 does not contribute to the output variance. Determining what inputs
are most important or what index value is meaningful is a common
question, but one for which there is no general rule or threshold. This
question is problem and context-dependent, but procedures have been
identified to rank order influential inputs and which can be used to
identify the least influential factors. These factors can be fixed to
simplify the model <a class="footnote-reference brackets" href="#id13" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#id15" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#id16" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>.</p>
<p>Next, we evaluate the total-order indices, which measure the
contribution to the output variance caused by varying the model input,
including both its first-order effects (the input varying alone) and all
higher-order interactions across the input parameters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_order</span> <span class="o">=</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total-order:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="n">total_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, x2: </span><span class="si">{</span><span class="n">total_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, x3: </span><span class="si">{</span><span class="n">total_order</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Total</span><span class="o">-</span><span class="n">order</span><span class="p">:</span>
<span class="n">x1</span><span class="p">:</span> <span class="mf">0.5184119098161343</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="mf">0.41021260250026054</span><span class="p">,</span> <span class="n">x3</span><span class="p">:</span> <span class="mf">0.2299058431439953</span>
</pre></div>
</div>
<p>The magnitude of the total order indices are substantially larger than
the first-order indices, which reveals that higher-order interactions
are occurring, i.e. that the interactions across inputs are also
explaining some of the total variance in the output. Note that 𝑥3 has
non-negligible total-order indices, which indicates that it is not a
consequential parameter when considered in isolation, but becomes
consequential and explains 25% of variance in the output through its
interactions with 𝑥1 and 𝑥2.</p>
<p>Finally, we can investigate these higher order interactions by viewing
the second-order indices. The second-order indicies measure the
contribution to the output variance caused by the interaction between
any two model inputs. Some computing error can appear in these
sensitivity indices, such as negative values. Typically, these computing
errors shrink as the number of samples increases.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">second_order</span> <span class="o">=</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S2&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Second-order:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1-x2:  </span><span class="si">{</span><span class="n">second_order</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1-x3:  </span><span class="si">{</span><span class="n">second_order</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2-x3:  </span><span class="si">{</span><span class="n">second_order</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Second</span><span class="o">-</span><span class="n">order</span><span class="p">:</span>
<span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">:</span>  <span class="o">-</span><span class="mf">0.043237389723234154</span>
<span class="n">x1</span><span class="o">-</span><span class="n">x3</span><span class="p">:</span>  <span class="mf">0.17506452088709862</span>
<span class="n">x2</span><span class="o">-</span><span class="n">x3</span><span class="p">:</span>  <span class="o">-</span><span class="mf">0.03430682392607577</span>
</pre></div>
</div>
<p>We can see that there are strong interactions between 𝑥1 and 𝑥3. Note
that in the Ishigami function, these two variables are multiplied in the
last term of the function, which leads to interactive effects. If we
were considering first order indices alone, we would erroneously assume
that 𝑥3 explains no variance in the output, but the second-order and
total order indices reveal that this is not the case. It’s easy to
understand where we might see interactive effects in the case of the
simple Ishigami function. However, it’s important to remember that in
more complex systems, there may be many higher-order interactions that
are not apparent, but could be extremely consequential in explaining the
variance of the output.</p>
</section>
<section id="tips-to-apply-sobol-sa-to-your-own-problem">
<h4><span class="section-number">B.2.1.7. </span>Tips to Apply Sobol SA to Your Own Problem<a class="headerlink" href="#tips-to-apply-sobol-sa-to-your-own-problem" title="Link to this heading">#</a></h4>
<p>In this tutorial, we demonstrated how to apply an SA analysis to a
simple mathematical test function. In order to apply a Sobol SA to your
own problem, you will follow the same general workflow that we defined
above. You will need to:</p>
<ol class="arabic simple">
<li><p>Choose sampling bounds for your parameters and set up the problem
dictionary as in Step 1 above.</p></li>
<li><p>Generate samples using the <code class="docutils literal notranslate"><span class="pre">saltelli.sample</span></code> function. This step is
problem-dependent and note that the Sobol method can be
computationally intensive depending on the model being analyzed. For
example, for a simple rainfall-runoff model such as HYMOD, it has
been recommended to run a sample size of at least N = 10,000 (which
translates to 60,000 model runs). More complex models will be slower
to run and will also require more samples to calculate accurate
estimates of Sobol indices. Once you complete this process, pay
attention to the confidence bounds on your sensitivity indices to see
whether you need to run more samples.</p></li>
<li><p>Run the parameter sets through your model. In the example above, the
Ishigami function could be evaluated through SALib since it is a
built in function. For your application, you will need to run these
parameter sets through the problem externally and save the output.
The output file should contain one row of output values for each
model run.</p></li>
<li><p>Calculate the Sobol indices. Now, the Y will be a numpy array with
your external model output and you will need to include the parameter
samples as an additional argument.</p></li>
<li><p>Finally, we interpet the results. If the confidence intervals of your
dominant indices are larger than roughly 10% of the value itself, you
may want to consider increasing your sample size as computation
permits. You should additionally read the references noted in Step 5
above to understand more about identifying important factors.</p></li>
</ol>
<p><strong>References</strong></p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id10" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">1</a><span class="fn-bracket">]</span></span>
<p>Saltelli, A. (2002). “Making best use of model evaluations to compute sensitivity indices.” Computer Physics Communications, 145(2):280-297, doi:<a class="reference external" href="https://doi.org/10.1016/S0010-4655(02)00280-1">10.1016/S0010-4655(02)00280-1</a>.</p>
</aside>
<aside class="footnote brackets" id="id11" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">2</a><span class="fn-bracket">]</span></span>
<p>Saltelli, A., P. Annoni, I. Azzini, F. Campolongo, M. Ratto, and S. Tarantola (2010). “Variance based sensitivity analysis of model output. Design and estimator for the total sensitivity index.” Computer Physics Communications, 181(2):259-270, doi:<a class="reference external" href="https://doi.org/10.1016/j.cpc.2009.09.018">10.1016/j.cpc.2009.09.018</a>.</p>
</aside>
<aside class="footnote brackets" id="id12" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">3</a><span class="fn-bracket">]</span></span>
<p>Sobol, I. M. (2001). “Global sensitivity indices for nonlinear mathematical models and their Monte Carlo estimates.” Mathematics and Computers in Simulation, 55(1-3):271-280, doi:<a class="reference external" href="https://doi.org/10.1016/S0378-4754(00)00270-6">10.1016/S0378-4754(00)00270-6</a>.</p>
</aside>
<aside class="footnote brackets" id="id13" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">4</a><span class="fn-bracket">]</span></span>
<p>T. H. Andres, “Sampling methods and sensitivity analysis for large parameter sets,” Journal of Statistical Computation and Simulation, vol. 57, no. 1–4, pp. 77–110, Apr. 1997, doi:<a class="reference external" href="https://doi.org/10.1080/00949659708811804">10.1080/00949659708811804</a>.</p>
</aside>
<aside class="footnote brackets" id="id15" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">5</a><span class="fn-bracket">]</span></span>
<p>Y. Tang, P. Reed, T. Wagener, and K. van Werkhoven, “Comparing sensitivity analysis methods to advance lumped watershed model identification and evaluation,” Hydrology and Earth System Sciences, vol. 11, no. 2, pp. 793–817, Feb. 2007, doi:<a class="reference external" href="https://doi.org/10.5194/hess-11-793-2007">10.5194/hess-11-793-2007</a>.</p>
</aside>
<aside class="footnote brackets" id="id16" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">6</a><span class="fn-bracket">]</span></span>
<p>J. Nossent, P. Elsen, and W. Bauwens, “Sobol’ sensitivity analysis of a complex environmental model,” Environmental Modelling &amp; Software, vol. 26, no. 12, pp. 1515–1525, Dec. 2011, doi:<a class="reference external" href="https://doi.org/10.1016/j.envsoft.2011.08.010">10.1016/j.envsoft.2011.08.010</a>.</p>
</aside>
</aside>
</section>
</section>
</section>
<section id="logistic-regression-tutorial">
<h2><span class="section-number">B.3. </span>Logistic Regression Tutorial<a class="headerlink" href="#logistic-regression-tutorial" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/basin_users_logistic_regression.ipynb">Logistic Regression Tutorial</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<section id="tutorial-logistic-regression-for-factor-mapping">
<h3><span class="section-number">B.3.1. </span>Tutorial: Logistic Regression for Factor Mapping<a class="headerlink" href="#tutorial-logistic-regression-for-factor-mapping" title="Link to this heading">#</a></h3>
<p>This tutorial replicates a scenario discovery analysis performed in
<a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2020EF001503">Hadjimichael et
al. (2020)</a>.</p>
<section id="background">
<h4><span class="section-number">B.3.1.1. </span>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h4>
<p>Planners in the the Upper Colorado River Basin (UCRB, shown in the
figure below) are seeking to understand the vulnerability of water users
to uncertainties stemming from climate change, population growth and
water policy changes. The UCRB spans 25,682 km2 in western Colorado and
is home to approximately 300,000 residents and 1,012 km2 of irrigated
land. Several thousand irrigation ditches divert water from the main
river and its tributaties for irrigation (shown as small black dots in
the figure). Transmountain diversions of approximately 567,400,000 m3
per year are exported for irrigation, industrial and municipal uses in
northern and eastern Colorado, serving the major population centers of
Denver and Colorado Springs. These diversions are carried through
tunnels, shown as large black dots in the figure.</p>
<img alt="_images/basin_map.png" src="_images/basin_map.png" />
<p>An important planning consideration is the water rights of each user,
defined by seniority across all water uses (irrigation diversions,
transboundary diversions, power plants etc.) in the basin. To assess the
vulnerability of users with varying degrees of water rights seniority,
planners simulate the system across an ensemble of scenarios using the
state of Colorado’s StateMod platform. The model simulates streamflow,
diversions, instream demands, and reservoir operations.</p>
<p>Hadjimichael et al. (2020) employ an exploratory analysis by simulating
a large ensemble of plausible scenarios using StateMod and then
identifying consequential decision-relevant combinations of uncertain
factors, termed scenario discovery. Focusing on decision-relevant
metrics (metrics that are important to the user, the scenario discovery
is applied to the water shortages experienced by each individual user
(i.e., not on a single basin-wide or sector-wide metric). For this
training example, we’ll be performing scenario discovery for three
different water users: two irrigation users and one municipal user.</p>
</section>
<section id="id19">
<h4><span class="section-number">B.3.1.2. </span>Let’s get started!<a class="headerlink" href="#id19" title="Link to this heading">#</a></h4>
<p>In this tutorial, we will be loading in data that has been produced in
Hadjimichael et al. (2020). Before we start our analysis, we’ll load the
relevant Python libraries, example data, and information for the three
users.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.package_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_basin_param_bounds</span><span class="p">,</span> <span class="n">load_lhs_basin_sample</span><span class="p">,</span> <span class="n">load_user_heatmap_array</span><span class="p">,</span> <span class="n">load_user_pseudo_scores</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">fit_logit</span><span class="p">,</span> <span class="n">plot_contour_map</span>

<span class="c1"># Select the IDs for the three users that we will perform the analysis for</span>
<span class="n">all_IDs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;7000550&#39;</span><span class="p">,</span><span class="s1">&#39;7200799&#39;</span><span class="p">,</span><span class="s1">&#39;3704614&#39;</span><span class="p">]</span>
<span class="n">usernames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Medium seniority irrigation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Low seniority irrigation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Transbasin municipal diversion&#39;</span><span class="p">]</span>
<span class="n">nStructures</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_IDs</span><span class="p">)</span>

<span class="c1"># Install package data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.install_supplement</span><span class="w"> </span><span class="kn">import</span> <span class="n">install_package_data</span>
<span class="n">install_package_data</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Downloading</span> <span class="n">example</span> <span class="n">data</span> <span class="k">for</span> <span class="n">msdbook</span> <span class="n">version</span> <span class="mf">0.1.5</span><span class="o">...</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">uncertain_params_bounds</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_metric_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_vary_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_mth_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">solutions</span><span class="o">.</span><span class="n">resultfile</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3704614</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">LHsamples_original_1000</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3704614</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">param_values</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_yr_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_mth_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7000550</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">collapse_days</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">hymod_params_256samples</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_vary_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7000550</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7200799</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_yr_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7200799</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">LeafCatch</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">hymod_simulations_256samples</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Robustness</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</section>
<section id="step-1-load-latin-hypercube-sample-and-set-up-problem">
<h4><span class="section-number">B.3.1.3. </span>Step 1: Load Latin hypercube sample and set up problem<a class="headerlink" href="#step-1-load-latin-hypercube-sample-and-set-up-problem" title="Link to this heading">#</a></h4>
<p>To examine regional vulnerability, we generate an ensemble of plausible
future states of the world (SOWs) using Latin Hypercube Sampling. For
this tutorial, we’ll load a file containing 1,000 samples across 14
parameters. The sampled parameters encompass plausible changes to the
future state of the basin, including changes to hydrology, water demands
(irrigation, municipal &amp; industry, transbasin), and institutional and
environmental factors (environmental flows, reservoir storage, operation
of the Shoshone Power Plant). These samples are taken from ranges
identified in <code class="docutils literal notranslate"><span class="pre">param_bounds</span></code>. Below we load in the 1000 samples, the
range of values that the samples can take for each parameter, and the
parameter names. More information on what each parameter constitutes can
be found in Table 1 of Hadjimichael et al., 2020.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Identify the bounds for each of the 14 parameters</span>
<span class="n">param_bounds</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_basin_param_bounds</span><span class="p">()</span>

<span class="c1">#Load in the parameter samples</span>
<span class="n">LHsamples</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_lhs_basin_sample</span><span class="p">()</span>

<span class="c1">#Create an array of the parameter names</span>
<span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Irrigation demand multiplier&#39;</span><span class="p">,</span><span class="s1">&#39;Reservoir loss&#39;</span><span class="p">,</span><span class="s1">&#39;Transbasin demand multiplier&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Municipal &amp; industrial multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;Shoshone&#39;</span><span class="p">,</span><span class="s1">&#39;Environmental flows&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Evaporation change&#39;</span><span class="p">,</span><span class="s1">&#39;Mean dry flow&#39;</span><span class="p">,</span><span class="s1">&#39;Dry flow variance&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Mean wet flow&#39;</span><span class="p">,</span><span class="s1">&#39;Wet flow variance&#39;</span><span class="p">,</span><span class="s1">&#39;Dry-dry probability&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Wet-wet probability&#39;</span><span class="p">,</span> <span class="s1">&#39;Snowmelt shift&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="step-2-define-decision-relevant-metrics-for-illustration">
<h4><span class="section-number">B.3.1.4. </span>Step 2: Define decision-relevant metrics for illustration<a class="headerlink" href="#step-2-define-decision-relevant-metrics-for-illustration" title="Link to this heading">#</a></h4>
<p>Scenario discovery attempts to identify parametric regions that lead to
‘success’ and ‘failure’. For this demonstration we’ll be defining
‘success’ as states of the world where a shortage level doesn’t exceed
its historical frequency.</p>
</section>
<section id="step-3-run-the-logistic-regression">
<h4><span class="section-number">B.3.1.5. </span>Step 3: Run the logistic regression<a class="headerlink" href="#step-3-run-the-logistic-regression" title="Link to this heading">#</a></h4>
<p>Logistic regression estimates the probability that a future SOW will be
classified as a success or failure given a set of performance criteria.
A logistic regression model is defined by:</p>
<div class="math notranslate nohighlight">
\[ln \bigg (\frac{p_i}{1-p_i} \bigg ) = X^T_i \beta\]</div>
<p>where <span class="math notranslate nohighlight">\(p_i\)</span> is the probability the performance in the
<span class="math notranslate nohighlight">\(i^{th}\)</span> SOW will be classified as a success, <span class="math notranslate nohighlight">\(X_i\)</span> is the
vector of covariates describing the <span class="math notranslate nohighlight">\(i^{th}\)</span> SOW, and
<span class="math notranslate nohighlight">\(\beta\)</span> is the vector of coefficients describing the relationship
between the covariates and the response, which here will be estimated
using maximum likelihood estimation.</p>
<p>A logistic regression model was fit to the ensemble of SOWs using the
performance criteria defined in step 2. Logistic regression modeling was
conducted using the <a class="reference external" href="https://www.statsmodels.org/stable/index.html">Statsmodel
Python</a> package. The
data required for the full analysis is too large to include in this
tutorial, but results can be found in the data file loaded below.</p>
<p>The results files contain the occurrence of different shortage frequency
and magnitude combinations under the experiment, in increments of 10,
between 0 and 100. These combinations (100 for each user) are
alternative decision-relevant metrics that can be used for scenario
discovery.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set arrays for shortage frequencies and magnitudes</span>
<span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">realizations</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Load performance and pseudo r scores for each of the users</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">msdbook</span><span class="o">.</span><span class="n">load_user_heatmap_array</span><span class="p">(</span><span class="n">all_IDs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_IDs</span><span class="p">))]</span>
</pre></div>
</div>
</section>
<section id="step-4-factor-ranking">
<h4><span class="section-number">B.3.1.6. </span>Step 4: Factor ranking<a class="headerlink" href="#step-4-factor-ranking" title="Link to this heading">#</a></h4>
<p>To rank the importance of each uncertain factor, we utilize McFadden’s
psuedo-R2, a measure that quantifies the improvement of the model when
utilizing each given predictor as compared to prediction using the mean
of the data set:</p>
<div class="math notranslate nohighlight">
\[R^2_{McFadden}=1-\frac{ln \hat{L}(M_{full})}{ln \hat{L}(M_{intercept})}\]</div>
<p>Here <span class="math notranslate nohighlight">\(ln \hat{L}(M_{full})\)</span> is the log likelihood of the full
model (including the predictor) and <span class="math notranslate nohighlight">\(ln \hat{L}(M_{intercept})\)</span> is
the log likelihood of the intercept model (which predicts the mean
probability of success across all SOWs).</p>
<p>Higher values of McFadden’s pseudo-R2 indicate higher factor importance
(when the likelihood of the full model approaches one, the ratio of the
likelihood of the full model compared to the intercept model will get
very small).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the pseudo-R^2 scores</span>
<span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">msdbook</span><span class="o">.</span><span class="n">load_user_pseudo_scores</span><span class="p">(</span><span class="n">all_IDs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_IDs</span><span class="p">))]</span>

<span class="c1"># Select indices of frequency and magnitudes that will be used for the visualization</span>
<span class="n">freq</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mag</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="step-5-draw-factor-maps">
<h4><span class="section-number">B.3.1.7. </span>Step 5: Draw factor maps<a class="headerlink" href="#step-5-draw-factor-maps" title="Link to this heading">#</a></h4>
<p>The McFadden’s pseudo-R2 scores files contain preliminary logistic
regression results on parameter importance for each of these
combinations. Using these pseudo-R2 scores we will identify the two most
important factors for each metric which we’ll use to generate the final
scenario discovery maps (note: there may be more than two important
metrics for each user, but here we will demonstrate by mapping two).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">)):</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">allSOWsperformance</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">all_pseudo_r_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># construct dataframe</span>
    <span class="n">dta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">LHsamples</span><span class="p">,</span> <span class="n">realizations</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">param_names</span><span class="p">)</span>
    <span class="n">dta</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allSOWsperformance</span><span class="p">[</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mag</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>

    <span class="n">pseudo_r_scores</span> <span class="o">=</span> <span class="n">all_pseudo_r_scores</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">+</span><span class="s1">&#39;yrs_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">[</span><span class="n">mag</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">+</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">top_predictors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pseudo_r_scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#Sort scores and pick top 2 predictors</span>

    <span class="c1"># define color map for dots representing SOWs in which the policy</span>
    <span class="c1"># succeeds (light blue) and fails (dark red)</span>
    <span class="n">dot_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">227</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">28</span><span class="p">],[</span><span class="mi">166</span><span class="p">,</span><span class="mi">206</span><span class="p">,</span><span class="mi">227</span><span class="p">]])</span><span class="o">/</span><span class="mf">255.0</span><span class="p">)</span>

    <span class="c1"># define color map for probability contours</span>
    <span class="n">contour_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>

    <span class="c1"># define probability contours</span>
    <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># define base values of the predictors</span>
    <span class="n">SOW_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># default parameter values for base SOW</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">SOW_values</span><span class="p">[</span><span class="n">top_predictors</span><span class="p">]</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">param_bounds</span><span class="p">[</span><span class="n">top_predictors</span><span class="p">]</span>

    <span class="c1"># define grid of x (1st predictor), and y (2nd predictor) dimensions</span>
    <span class="c1"># to plot contour map over</span>
    <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">param_bounds</span><span class="p">[</span><span class="n">top_predictors</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">param_bounds</span><span class="p">[</span><span class="n">top_predictors</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">500</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">param_bounds</span><span class="p">[</span><span class="n">top_predictors</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">param_bounds</span><span class="p">[</span><span class="n">top_predictors</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">500</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">all_predictors</span> <span class="o">=</span> <span class="p">[</span> <span class="n">dta</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_predictors</span><span class="p">]</span>
    <span class="n">dta</span><span class="p">[</span><span class="s1">&#39;Interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dta</span><span class="p">[</span><span class="n">all_predictors</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">dta</span><span class="p">[</span><span class="n">all_predictors</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># logistic regression here</span>
    <span class="n">predictor_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_predictors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">fit_logit</span><span class="p">(</span><span class="n">dta</span><span class="p">,</span> <span class="n">predictor_list</span><span class="p">)</span>

    <span class="c1"># plot contour map</span>
    <span class="n">contourset</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">plot_contour_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dta</span><span class="p">,</span> <span class="n">contour_cmap</span><span class="p">,</span>
                                          <span class="n">dot_cmap</span><span class="p">,</span> <span class="n">contour_levels</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span>
                                          <span class="n">ygrid</span><span class="p">,</span> <span class="n">all_predictors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">all_predictors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">usernames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># set up colorbar</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contourset</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
<span class="n">cbar_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability of Success&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">cbar_ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">statsmodels</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">127</span><span class="p">:</span> <span class="n">ValueWarning</span><span class="p">:</span> <span class="n">unknown</span> <span class="n">kwargs</span> <span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ValueWarning</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Optimization</span> <span class="n">terminated</span> <span class="n">successfully</span><span class="o">.</span>
         <span class="n">Current</span> <span class="n">function</span> <span class="n">value</span><span class="p">:</span> <span class="mf">0.378619</span>
         <span class="n">Iterations</span> <span class="mi">8</span>
<span class="n">Optimization</span> <span class="n">terminated</span> <span class="n">successfully</span><span class="o">.</span>
         <span class="n">Current</span> <span class="n">function</span> <span class="n">value</span><span class="p">:</span> <span class="mf">0.397285</span>
         <span class="n">Iterations</span> <span class="mi">8</span>
<span class="n">Optimization</span> <span class="n">terminated</span> <span class="n">successfully</span><span class="o">.</span>
         <span class="n">Current</span> <span class="n">function</span> <span class="n">value</span><span class="p">:</span> <span class="mf">0.377323</span>
         <span class="n">Iterations</span> <span class="mi">8</span>
</pre></div>
</div>
<img alt="_images/notebook_logistic_output_11_1.png" src="_images/notebook_logistic_output_11_1.png" />
<p>The figure above demonstrates how different combinations of the
uncertain factors lead to success or failure in different states of the
world, which are denoted by the blue and red dots respectively. The
probability of success and failure are further denoted by the contours
in the figure. Several insights can be drawn from this figure.</p>
<p>First, using metrics chosen to be decision-relevant (specific to each
user) causes different factors to be identified as most important by
this scenario-discovery exercise (the x- and y-axes for each of the
subplots). In other words, depending on what the decision makers of this
system want to prioritize they might choose to monitor different
uncertain factors to track performance.</p>
<p>Second, in the top panel, the two identified factors appear to also have
an interactive effect on the metric used (shortages of a certain level
and frequency in this example). In terms of scenario discovery, the
Patient Rule Induction Method (PRIM) or Classification And Regression
Trees (CART) would not be able to delineate this non-linear space and
would therefore misclassify parameter combinations as ‘desirable’ when
they were in fact undesirable, and vice versa.</p>
<p>Lastly, logistic regression also produces contours of probability of
success, i.e. different factor-value combinations are assigned different
probabilities that a shortage level will be exceeded. This allows the
decision makers to evaluate these insights while considering their risk
aversion.</p>
</section>
<section id="tips-to-apply-scenario-discovery-to-your-own-problem">
<h4><span class="section-number">B.3.1.8. </span>Tips to Apply Scenario Discovery to Your Own Problem<a class="headerlink" href="#tips-to-apply-scenario-discovery-to-your-own-problem" title="Link to this heading">#</a></h4>
<p>In this tutorial, we demonstrated how to perform a scenario discovery
analysis for three different users in the UCRB. The analysis allowed us
to determine which parameters the users would be most affected by and to
visualize how different ranges of these parameters lead to success and
failure for different users. This framework can be applicable to any
other application where it is of interest to characterize success and
failure based on uncertain parameter ranges. In order to apply the same
framework to your own problem:</p>
<ol class="arabic simple">
<li><p>Choose sampling bounds for your parameters of interest, which will
represent uncertainties that characterize your system.</p></li>
<li><p>Generate samples for these parameters (this can be done using the
<code class="docutils literal notranslate"><span class="pre">saltelli.sample</span></code> function or externally).</p></li>
<li><p>Define what constitutes success and failure in your problem. In this
tutorial, success was defined based on not surpassing the historical
drought frequency. Choose a metric that is relevant to your problem
and decision-makers that might be involved. If your model involves an
optimization, you can also define metrics based on meeting certain
values of these objectives.</p></li>
<li><p>Run the parameter sets through your model and calculate success and
failure based on your metrics and across different users if
applicable. This step will allow you to create the scatter plot part
of the final figure.</p></li>
<li><p>If it is of interest, the contours on the figure can be created by
fitting the logistic regression model in a similar manner as denoted
in Steps 3 and 5 of the tutorial.</p></li>
</ol>
</section>
</section>
</section>
<section id="hymod-dynamics-tutorial">
<h2><span class="section-number">B.4. </span>HYMOD Dynamics Tutorial<a class="headerlink" href="#hymod-dynamics-tutorial" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/hymod.ipynb">HYMOD Notebook</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<section id="tutorial-sensitivity-analysis-of-the-hymod-model">
<h3><span class="section-number">B.4.1. </span>Tutorial: Sensitivity Analysis of the HYMOD Model<a class="headerlink" href="#tutorial-sensitivity-analysis-of-the-hymod-model" title="Link to this heading">#</a></h3>
<p>The purpose of this tutorial is to demonstrate the global sensitivity
analysis concepts and tools established in the Section 3.1 of the main
text of this eBook. This demonstration will highlight the central role
of design of experiments (Section 3.3), when implementing global
sensitivity analysis tools described in Section 3.4.</p>
<p>We’ll explore these tools and concepts using the HYdrological MODel
(HYMOD), a rainfall-runoff model developed and used for river flow
forecasting. HYMOD was chosen for demonstration because its purpose is
to abstract highly complex and non-linear systems. The methods
demonstrated in this tutorial can be applied to numerical models that
simulate other complex non-linear systems.</p>
<p>This tutorial will first introduce HYMOD and use it to simulate
streamflows in a river basin. Next, we’ll employ sensitivity analysis
concepts described in Section 3 of the main text to examine how values
of HYMOD’s parameters impact streamflow predictions. Finally, we’ll
explore how the effects of these parameters may change over time using
time-varying sensitivity analysis.</p>
<p>The tutorial includes the following steps:</p>
<p>1.1 - Introduction to a simple hydrologic model (HYMOD)</p>
<p>1.2 - Input Data</p>
<p>1.3 - Running a basic simulation</p>
<p>1.4 - Model outputs</p>
<p>2.1 - Design of Experiments</p>
<p>2.2 - Sensitivity analysis for one output</p>
<p>2.3 - Sensitivity analysis across multiple outputs</p>
<p>2.4 - Time-varying sensitivity analysis</p>
</section>
<section id="introduction-to-hymod">
<h3><span class="section-number">B.4.2. </span>1 - Introduction to HYMOD<a class="headerlink" href="#introduction-to-hymod" title="Link to this heading">#</a></h3>
<p id="hymod">1.1 Overview</p>
<p>HYMOD is a hydrologic model (rainfall-runoff model) that simulates key
hydrologic fluxes such as infiltration, streamflow and
evapotranspiration. The model was originally developed and used for
river flow forecasting, but it has also been been used to explore
different sensitivity analysis (e.g., <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/wrcr.20124">Herman et al.,
2013</a>),
uncertainty quantification (e.g., <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2006WR005205">Smith et al.,
2008</a>),
and optimization (e.g., <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0022169414006362?casa_token=IRqE19Hkfa8AAAAA:_fXOqfwpzxMpchvu8_0njCe0Ok9H29Gyw2F46l9PzG9UVODDTUg6wIOSiyp6uybGevNVnZ7N">Ye et al.,
2014</a>)
concepts.</p>
<p>HYMOD accepts two inputs - daily precipitation and daily potential
evapotranspiration (PET)- and generates predictons of daily streamflow.
HYMOD abstracts the highly non-linear process of runoff routing by
dividing the flow into two components: quick flow, representing
precipitation that quickly runs off the surface of the watershed into
the stream, and slow flow, that moves through the soil and takes much
longer to arrive at the stream.</p>
<p>To generate streamflow predictions, HYMOD first models vertical
processes within the watershed to determine how much water infiltrates
and evaporates from the soil at a given time step. It then determines
how much water should be partitioned into quick flow and slow flow
processes. Within each process it abstracts residence time (the time it
takes a unit volume of water to move through the watershed and into the
stream) using a series of “reservoirs” each with a calibrated residence
time.</p>
<p>HYMOD’s representation of hydrologic processes are shown Figure 1 below
and controlled by the following parameters:</p>
<p><span class="math notranslate nohighlight">\(H_{uz}\)</span>: the maximum water storage capacity of the soil (mm)</p>
<p><span class="math notranslate nohighlight">\(B_{exp}\)</span>: parameters describing the degree of spatial variability
within the basin between 0 and Huz</p>
<p><span class="math notranslate nohighlight">\(Alp\)</span>: Fraction of runoff contributing to quick flow</p>
<p><span class="math notranslate nohighlight">\(K_q\)</span>: Quick flow residence time of linear infinite reservoir (the
Kq values of all three linear reservoirs are the same)</p>
<p><span class="math notranslate nohighlight">\(K_s\)</span>: Slow flow residence time of linear infinite reservoir</p>
<img alt="_images/hymod_schematic-DAVE.png" src="_images/hymod_schematic-DAVE.png" />
<p>HYMOD models the fraction of water that is stored in the soil
<span class="math notranslate nohighlight">\((F(XH_{uz}))\)</span> using the following relationship:</p>
<div class="math notranslate nohighlight">
\[F(XH_{uz}) = 1 - (1 - \frac{XH_{uz}}{H_{uz}})^{B}\]</div>
<p>where <span class="math notranslate nohighlight">\(XH_{uz}\)</span> is the water storage capacity of the soil;
<span class="math notranslate nohighlight">\(H_{uz}\)</span> is the parameter describing basin maximum water
storage capacity (mm); and <span class="math notranslate nohighlight">\(B\)</span> is the parameter describing the
degree of spatial variability within the basin.</p>
<p>The portion of precipitation that exceeds the water storage capacity is
treated as runoff.</p>
<p>To route runoff to streamflow, the excess runoff from the vertical
processes is split into quick flow and slow flow. The proportion of
runoff partitioned into quick flow and slow flow is determined by a
parameter <span class="math notranslate nohighlight">\(Alp\)</span>, which ranges between 0 and 1. Quick flow is
routed through <span class="math notranslate nohighlight">\(N\)</span> identical quick flow tanks <span class="math notranslate nohighlight">\(Q1, Q2... QN\)</span>
(shown above as <span class="math notranslate nohighlight">\(N=3\)</span>). The rate at which runoff moves through the
quick flow system is described by the residence time of the quick flow
tanks, <span class="math notranslate nohighlight">\(Kq\)</span> (day). Slow flow is routed through a parallel slow
flow tank and the rate at which slow flow is routed is described by the
slow flow residences time, <span class="math notranslate nohighlight">\(Ks\)</span> (day).</p>
<p>Citation: Wagener, T., Boyle, D. P., Lees, M. J., Wheater, H. S., Gupta,
H. V., &amp; Sorooshian, S. (2001). A framework for development and
application of hydrological models. Hydrology and Earth System Sciences,
5(1), 13-26.</p>
<p id="inputs">1.2 Input data</p>
<p>The HYMOD model only requires precipitation and potential
evapotranspiration as inputs. For this example, we’ll run HYMOD using
data from the Leaf River, a humid catchment located north of Collins
Mississippi that has been widely used to explore HYMOD. The dataset also
includes daily observed runoff that we later use to evaluate the
performance of each sensitivity analysis sample set.</p>
<p>In the following section of code, we’ll load the necessary python
libraries and read in the input file. For this exercise we’ll only use
the first eleven years of data. The first five rows of the input dataset
are printed to show what they look like:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">msdbook</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">msdbook.hymod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.package_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_hymod_input_file</span><span class="p">,</span> <span class="n">load_hymod_params</span><span class="p">,</span> <span class="n">load_hymod_simulation</span><span class="p">,</span> <span class="n">load_hymod_monthly_simulations</span><span class="p">,</span> <span class="n">load_hymod_annual_simulations</span><span class="p">,</span> <span class="n">load_hymod_varying_simulations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SALib.analyze</span><span class="w"> </span><span class="kn">import</span> <span class="n">sobol</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">metrics</span>

<span class="c1"># load example data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.install_supplement</span><span class="w"> </span><span class="kn">import</span> <span class="n">install_package_data</span>
<span class="n">install_package_data</span><span class="p">()</span>

<span class="c1"># load the Leaf River HYMOD input file</span>
<span class="n">leaf_data</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_hymod_input_file</span><span class="p">()</span>

<span class="c1"># extract the first eleven years of data</span>
<span class="n">leaf_data</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4015</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Leaf River Data structure:&#39;</span><span class="p">)</span>

<span class="c1"># There are only three columns in the file including precipitation, potential evapotranspiration and  streamflow</span>
<span class="n">leaf_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Downloading</span> <span class="n">example</span> <span class="n">data</span> <span class="k">for</span> <span class="n">msdbook</span> <span class="n">version</span> <span class="mf">0.1.5</span><span class="o">...</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">uncertain_params_bounds</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_metric_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_vary_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_mth_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">solutions</span><span class="o">.</span><span class="n">resultfile</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3704614</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">LHsamples_original_1000</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3704614</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">param_values</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_yr_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_mth_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7000550</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">collapse_days</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">hymod_params_256samples</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_vary_s1</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7000550</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7200799</span><span class="n">_heatmap</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sa_by_yr_delta</span><span class="o">.</span><span class="n">npy</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">7200799</span><span class="n">_pseudo_r_scores</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">LeafCatch</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">hymod_simulations_256samples</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Unzipped</span><span class="p">:</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">msdbook</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Robustness</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Leaf</span> <span class="n">River</span> <span class="n">Data</span> <span class="n">structure</span><span class="p">:</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Precip</th>
      <th>Pot_ET</th>
      <th>Strmflw</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>4.60</td>
      <td>0.29</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>4.31</td>
      <td>0.24</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>4.33</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>4.78</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>2.91</td>
      <td>0.18</td>
    </tr>
  </tbody>
</table>
</div><p>To visualize catchment hydrology, streamflow and precipitation data are
usually plotted together as a combined hydrograph (streamflow ) and
hyetograph (rainfall, from Greek hyetos, “rain”). Streamflow is plotted
as a time series, while rainfall is shown as an inverted bar plot along
the top of the graph. Streamflow labels are shown on the left y-axis,
while rainfall labels are shown on the right y-axis.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make an axis for the hydrograph</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">strmflw_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>

<span class="c1">#make a second y-axis for the hyetograph</span>
<span class="n">precip_ax</span> <span class="o">=</span> <span class="n">strmflw_ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">precip_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">precip_ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="n">precip</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Precip&#39;</span><span class="p">]</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Precip&#39;</span><span class="p">])),</span> <span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Strmflw&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Streamflow (mm/day)&#39;</span><span class="p">)</span>

<span class="n">precip_ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Precip&#39;</span><span class="p">])),</span> <span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Precip&#39;</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">precip_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rainfall (mm/day)&#39;</span><span class="p">)</span>
<span class="n">precip_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Precip&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Streamflow&#39;</span><span class="p">],</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7f53b95c6850</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="_images/hymod1.png" src="_images/hymod1.png" />
<p id="baseline">1.3 Running a Baseline Model Simulation</p>
<p>We’ll start our experiment by running HYMOD using its default
parameters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># assign input parameters to generate a baseline simulated streamflow</span>
<span class="n">Nq</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of quickflow routing tanks</span>
<span class="n">Kq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Quickflow routing tanks&#39; rate parameter</span>
<span class="n">Ks</span> <span class="o">=</span>  <span class="mf">0.001</span> <span class="c1"># Slowflow routing tank&#39;s rate parameter</span>
<span class="n">Alp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Quick/slow split parameter</span>
<span class="n">Huz</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Maximum height of soil moisture accounting tank</span>
<span class="n">B</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># Scaled distribution function shape parameter</span>

<span class="c1"># Note that the number of years is 11. One year of model warm-up and ten years are used for actual simulation</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">hymod</span><span class="p">(</span><span class="n">Nq</span><span class="p">,</span> <span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="o">=</span><span class="mi">4015</span><span class="p">)</span>
</pre></div>
</div>
<p id="outputs">1.4 Model Outputs</p>
<p>Model outputs include actual evapotranspiration, quick and fast
streamflow, and combined runoff. In this tutorial we focus on the total
daily runoff, QQ (<span class="math notranslate nohighlight">\(m^3/s\)</span>). We can use the following script to
plot simulated streamflow against observed streamflow.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-observed-vs-simulated-streamflow">plot_observed_vs_simulated_streamflow</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_observed_vs_simulated_streamflow</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">leaf_data</span><span class="p">,</span> <span class="n">hymod_dict</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod2.png" src="_images/hymod2.png" />
<p>So how does our model perform? We can investigate model performance
across several metrics:</p>
<p>1: Mean Absolute Error (MAE); MAE conveys how the model performs on
average across the 10 year simulation period, with smaller values
indicating better performance. The absolute value is taken so that
positive and negative errors do not cancel each other out.</p>
<div class="math notranslate nohighlight">
\[MAE = \frac{1}{N}\sum_{t=0}^N\left\lvert Q_{sim,t}-Q_{obs,t}\right\rvert\]</div>
<p>2: Root Mean Square Error (RMSE); RMSE is sum of square errors across
the 10 year simulation period. RMSE is sensitive to large errors between
the historical record and the simulated flows, and thus is useful for
highlighting the model’s ability to capture of extreme flood events.</p>
<div class="math notranslate nohighlight">
\[RMSE = \sqrt{\frac{1}{N}\sum_{t=1}^{N}(Q_{sim,t}-Q_{obs,t})^2}\]</div>
<p>3: Log-Root Mean Square Error (Log(RMSE)) LOG(RMSE) focuses on model
performance during low-flow events.</p>
<div class="math notranslate nohighlight">
\[LOG(RMSE) = log(RMSE)\]</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Strmflw&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]))</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Strmflw&#39;</span><span class="p">])</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">mse</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">RMSE: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">LOG(RMSE): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MAE</span><span class="p">:</span> <span class="mf">1.0787471470460999</span>
<span class="n">RMSE</span><span class="p">:</span> <span class="mf">4.375695937555197</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">RMSE</span><span class="p">):</span> <span class="mf">2.0918164206151544</span>
</pre></div>
</div>
<p>The error metrics show that HYMOD performs reasonably well, the MAE is
around 1 <span class="math notranslate nohighlight">\(m^3/s\)</span>, the RMSE is on the order of 10% of the largest
observed streamflow and the LOG(RMSE) is fairly low.</p>
</section>
<section id="global-sensitivity-analysis">
<h3><span class="section-number">B.4.3. </span>2- Global Sensitivity Analysis<a class="headerlink" href="#global-sensitivity-analysis" title="Link to this heading">#</a></h3>
<p id="sensitivity">2.1 Experimental Design and Setup</p>
<p>Now we’ll examine how sensitive streamflow simulations generated by
HYMOD are to the model’s input parameters. We’ll perform global
sensitivity analysis (see Section 3.1 of the main text) using the SALib
Python library.</p>
<p>A first and critical step when conducting sensitivity analysis is
determining the experimental design (see Design of Experiments, Section
3.4 of the main text). Our experimental design involves defining the
uncertainties that we’ll be examining, the output of interest, the
ranges of each uncertainty that will be explored and the strategy for
sampling the uncertainty space.</p>
<p>For this experiment we’ll explore the five parameters highlighted in
Figure 1. We’ll draw their ranges from existing literature on the model
(note Jon H. paper). We’ll use a Sobol sampling an a quasi-random
sampling with low sequences approach to sample the uncertainty space
(Section 3.3.4).</p>
<p>In this demonstration we’ll utilize Sobol Sensitivity Analysis, a
variance based method (Section 3.4.5).</p>
<p>To explore HYMOD’s behavoir, we’ll examine the sensitivity of four model
ouputs to input parameters: 1) predicted flow, 2) Mean Absolute Error
(compared with the calibaration data set), 3) Root Mean Square Error and
1) Log Root Mean Square Error.</p>
<p>This analysis will employ SALib, a Python implementation also utilized
in the other SA tutorial (make this more formal).</p>
<p>To start our analysis, we’ll create a dictionary that describes our
model uncertainties and their ranges, this dictionary is named
“problem_hymod” (SALib refers to these dictionaries as “problems”).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">problem_hymod</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_vars&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span>
    <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Kq</span>
               <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>  <span class="c1"># Ks</span>
               <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>    <span class="c1"># Alp</span>
               <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span>  <span class="c1"># Huz</span>
               <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">]]</span>  <span class="c1"># B</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After defining our uncertainties and ranges, we’ll use SALib to sample
the uncertainty space and run the model for each of the sample sets. We
will load a sample that has already been created <code class="docutils literal notranslate"><span class="pre">param_values_hymod</span></code>
for demonstration purposes. For HYMOD, literature recommends running at
least N = 10,000 samples, to keep this demonstration easy to run
however, we utilize only 256 sobol samples of uncertainties. To generate
accurate approximations of second order sensitivity indices SALib
generates N*(2k+2) sets of samples, where N=256 and k=5 (number of
uncertainties). For the math behind why this is needed, see (Saltelli,
A., 2002. Making best use of model evaluations to compute sensitivity
indices. Computer Physics Communications 145, 280–297.
<a class="reference external" href="https://doi.org/10.1016/S0010-4655(02)00280-1">https://doi.org/10.1016/S0010-4655(02)00280-1</a>).</p>
<p>The actual model simulation takes an extended period, so we also load
the simulation data from a previous run. The following demonstrates how
to conduct this analysis:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate 256 samples.</span>
<span class="n">param_values_hymod</span> <span class="o">=</span> <span class="n">saltelli</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">problem_hymod</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

<span class="c1"># dictionary to store outputs in</span>
<span class="n">d_outputs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># run simulation for each parameter sample</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_values_hymod</span><span class="p">)):</span>

    <span class="c1"># run model for each sensitivity analysis parameter sets</span>
    <span class="n">hymod_output</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="p">(</span><span class="n">Nq</span><span class="p">,</span>
                                 <span class="n">param_values_hymod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                 <span class="n">param_values_hymod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                 <span class="n">param_values_hymod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                 <span class="n">param_values_hymod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                                 <span class="n">param_values_hymod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                                 <span class="n">leaf_data</span><span class="p">,</span>
                                 <span class="n">ndays</span><span class="o">=</span><span class="mi">4015</span><span class="p">)</span>

    <span class="c1"># store the simulated total flow discharge</span>
    <span class="n">d_outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Q</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hymod_output</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">]</span>


<span class="n">Q_df_bw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_outputs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load previously generated parameter values</span>
<span class="n">param_values_hymod</span> <span class="o">=</span> <span class="n">load_hymod_params</span><span class="p">()</span>

<span class="c1"># number of samples</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_values_hymod</span><span class="p">)</span>

<span class="c1"># load previously generated hymod simulated outputs</span>
<span class="n">Q_df_bw</span> <span class="o">=</span> <span class="n">load_hymod_simulation</span><span class="p">()</span>

<span class="c1"># column names of each sample simulation number</span>
<span class="n">sample_column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Q_df_bw</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>A hydrological model such as HYMOD usually includes ordinary
differential equations that are sensitive to their initial condition.
They also have components in their underlying formulation that have long
memory such that prior time steps can affect their current simulations.
For example, soil moisture or groundwater can hold water for a long time
and therefore they are often considered to exhibit a long memory. This
can affect the partitioning of water to runoff and infiltration, while
also controlling the generation of base flow. Therefore, it is important
to have a reasonable initial value for them. To achieve this,
hydrologists usually extend their simulation period and after the
simulations, they remove that extended time period that has unreasonable
groundwater or surface water values. This time period is called the
warm-up time period.</p>
<p>Here we extended our simulation for one year (from 10 years to 11 years)
and we removed the first year of simulation, therefore our warm-up
period is one year.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exclude the first year of simulation from the simulations and reset the index</span>
<span class="n">Q_df</span> <span class="o">=</span> <span class="n">Q_df_bw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">365</span><span class="p">:</span><span class="mi">4015</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># exclude the first year of the input data and reset the index</span>
<span class="n">leaf_data</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">365</span><span class="p">:</span><span class="mi">4015</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that HYMOD has been warmed up, we’ll examine how HYMOD’s streamflow
outputs vary under different sample sets, and compare them with the
observed streamflow.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add date columns to our simulation data frame; for this data our start date is 1/1/2000</span>
<span class="n">date_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">3650</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">Q_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span>
<span class="n">Q_df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span><span class="o">.</span><span class="n">year</span>
<span class="n">Q_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span><span class="o">.</span><span class="n">month</span>
<span class="n">Q_df</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span><span class="o">.</span><span class="n">day</span>

<span class="c1"># aggregate the simulated observed streamflow to monthly mean</span>
<span class="n">df_sim_mth_mean</span> <span class="o">=</span> <span class="n">Q_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])[</span><span class="n">sample_column_names</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># do the same for the observed data</span>
<span class="n">date_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">leaf_data</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span>
<span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span><span class="o">.</span><span class="n">year</span>
<span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span><span class="o">.</span><span class="n">month</span>
<span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_ts</span><span class="o">.</span><span class="n">day</span>

<span class="c1"># aggregate the daily observed streamflow to monthly mean</span>
<span class="n">df_obs_mth_mean</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-observed-vs-sensitivity-streamflow">plot_observed_vs_sensitivity_streamflow</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_observed_vs_sensitivity_streamflow</span><span class="p">(</span><span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_mth_mean</span><span class="p">,</span>
                                                           <span class="n">df_sim</span><span class="o">=</span><span class="n">df_sim_mth_mean</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod3.png" src="_images/hymod3.png" />
<p id="sametrics">2.2 Sensitivity of streamflows to model parameters</p>
<p>Now we’ll examine how each of HYMOD’s parameters impact the variance of
simulated streamflows. Using SALib we’ll calculate the first order and
total order sensitivity indices of each model parameter. The first
order sensitivity index measure’s the individual impact that a given
parameter has on the variance of the simulated streamflows. The total
order index measures the impact of a given parameter along with all
interactions that other parameters have with the given parameter on
simulated streamflows.</p>
<p>We’ll start with an matrix, Y, which contains our simulated streamflows
for every uncertainty sample. We’ll then use the sobol.analyze function
from SALib to calculate the sensitivity indices (Si). The arguments for
this function are the problem dictionary defined in part 2.2 of this
tutorial, and the matrix of simulated streamflows, Y.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># overall aggregated indices</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">Q_df</span><span class="p">[</span><span class="n">sample_column_names</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># Perform analysis</span>
<span class="n">Si</span> <span class="o">=</span> <span class="n">sobol</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem_hymod</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can examine our results, we’ll print the first order and total
order Si’s for each parameter, then visualize the results with bar plots</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First order indices = &#39;</span><span class="p">,</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total order indices = &#39;</span><span class="p">,</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">])</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;First order Si&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Total order Si&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">First</span> <span class="n">order</span> <span class="n">indices</span> <span class="o">=</span>  <span class="p">[</span><span class="mf">9.55550001e-05</span> <span class="mf">7.49249463e-04</span> <span class="mf">5.62386413e-04</span> <span class="mf">7.03327551e-01</span>
 <span class="mf">2.53701895e-01</span><span class="p">]</span>
<span class="n">Total</span> <span class="n">order</span> <span class="n">indicies</span> <span class="o">=</span>  <span class="p">[</span><span class="mf">1.76174200e-06</span> <span class="mf">1.63288175e-03</span> <span class="mf">3.41378460e-04</span> <span class="mf">6.88983864e-01</span>
 <span class="mf">2.53922146e-01</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod4.png" src="_images/hymod4.png" />
<p>Our findings indicate that in this instance, the streamflow estimate
from HYMOD is highly sensitive to soil moisture parameters Huz and B and
hardly affected by the routing parameters. Notably, there are very little
interactions between parameters causing the total order indices to be
nearly identical to the first order indices.</p>
<p id="diffperformance">2.3 How do different performance metrics affect the results of our
sensitivity analysis?</p>
<p>Streamflow has many different properties. In this section, we discuss
how the selection of metrics can lead to fundamentally different
sensitivity analysis results. For example, one can only focus on
aggregated streamflow metrics such as mean (what has been presented so
far), or only on extreme events such as drought or floods.</p>
<p>Here we compare three different metrics: 1- Mean error (ME) 2- Root Mean
Square Error (RMSE) 3- Log-Root Mean Square Error (Log(RMSE))</p>
<p>Each of these metrics focuses on a specific attribute of streamflow. For
example, RMSE highlights the impacts of extreme flood events, while
LOG(RMSE) focuses on model performance during low-flow events.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate error metrics</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">Q_df</span><span class="p">[</span><span class="n">sample_column_names</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">leaf_data</span><span class="p">[</span><span class="s2">&quot;Strmflw&quot;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">Q_df</span><span class="p">[</span><span class="n">sample_column_names</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">leaf_data</span><span class="p">[</span><span class="s2">&quot;Strmflw&quot;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">mse</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># add error metrics to a dictionary</span>
<span class="n">d_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">rmse</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="s1">&#39;LOG[RMSE]&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rmse</span><span class="o">.</span><span class="n">values</span><span class="p">)}</span>

<span class="c1"># convert to a dataframe</span>
<span class="n">df_metrics_SA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_metrics</span><span class="p">)</span>
</pre></div>
</div>
<p>We can use the following to calculate the SA indices for each metric and
visualize it.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_metric_s1_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>
<span class="n">df_metric_sT_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>

<span class="c1"># conduct sensitivity analysis for each metric</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

    <span class="c1"># get the data as a numpy array for the target metric</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">d_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># use the metric to conduct SA</span>
    <span class="n">Si</span> <span class="o">=</span> <span class="n">sobol</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem_hymod</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">print_to_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># add the sensitivity indices to the output data frame</span>
    <span class="n">df_metric_s1_result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">]</span>
    <span class="n">df_metric_sT_result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Si</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create seaborn heatmap with required labels</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="c1"># labels for y-axis</span>
<span class="n">y_axis_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mean Absolute Error&#39;</span><span class="p">,</span> <span class="s1">&#39;RSME&#39;</span><span class="p">,</span> <span class="s1">&#39;Log(RMSE)&#39;</span><span class="p">]</span>

<span class="c1"># plot heatmap</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_metric_s1_result</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">y_axis_labels</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno_r&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Si&#39;</span><span class="p">},</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;First Order Sensitivity&#39;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_metric_sT_result</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">y_axis_labels</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno_r&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Si&#39;</span><span class="p">})</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Order Sensitivity&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Total Order Sensitivity&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod5.png" src="_images/hymod5.png" />
<p>The first order sensitivity indices indicate that HYMOD’s sensitivity
to its parameters is different depending on how its output is measured.
Unsurprisingly, the mean absolute error is highly sensitive to the soil
moisture accounting parameters Huz and B, just like the overall
streamflow predictions above. However, when we examine RMSE and
log(RMSE), the routing parameters Alp become sensitive, and the
sensitivity to parameter B is reduced. As described above, RMSE and
LOG(RMSE) respond to model performance in high-flow and low flow periods
respectively. Our results indicate that for these flow regimes Alp, the
parameter that governs the split between quick and slow flow is an
important factor. While still the parameter with the highest most effect
on all three measures, Huz is much less influential for RMSE and
LOG(RMSE) than it is for MAE.</p>
<p>The total order sensitivity indices review a different, more complex
story. While the MAE sensitivity is relatively governed by first order
effects (like the streamflow predictions above), the RMSE and LOG(RMSE)
error metrics show significant interactions. Alp has the highest total
order sensitivity for RMSE and is equal to Huz for Log(RMSE). Kq, which
has a relatively low first order sensitivity index, shows strong
contribution to variance when interactions are taken into account.</p>
<p>Radial convergence plots are a helpful way to visualize the interactions
between parameters. These plots array the model parameters in a circle
and plot the first order, total order and second order Sobol sensitivity
indices for each parameter. The first order sensitivity is shown as the
size of a closed circle, the total order as the size of a larger open
circle and the second order as the thickness of a line connecting two
parameters. Below is an example of a radial convergence plot for the
LOG(RMSE) measure. The plot indicates strong interactions between the
Huz and Alp parameters, as well as Alp and Kq. There is also an
interaction between Alp and Ks.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;axes_linewidth&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;axes.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">})</span>

<span class="k">def</span><span class="w"> </span><span class="nf">is_significant</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">confidence_interval</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s2">&quot;conf&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="o">==</span> <span class="s2">&quot;conf&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">confidence_interval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">grouped_radial</span><span class="p">(</span><span class="n">SAresults</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">radSc</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">widthSc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">STthick</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">varNameMult</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gpNameMult</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s2">&quot;conf&quot;</span><span class="p">):</span>
    <span class="c1"># Derived from https://github.com/calvinwhealton/SensitivityAnalysisPlots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># initialize parameters and colors</span>
    <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
            <span class="n">color_map</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">color_map</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">radSc</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">radSc</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">radSc</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="c1"># plot second-order indices</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_significant</span><span class="p">(</span><span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;S2&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;S2_conf&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">angle</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

            <span class="n">line_hw</span> <span class="o">=</span> <span class="n">scaling</span><span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;S2&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="n">widthSc</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_hw</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.75&quot;</span><span class="p">))</span>

    <span class="c1"># plot total order indices</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_significant</span><span class="p">(</span><span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;ST_conf&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">scaling</span><span class="o">*</span><span class="p">(</span><span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="n">widthSc</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">scaling</span><span class="o">*</span><span class="p">(</span><span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="n">widthSc</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">STthick</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.4&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># plot first-order indices</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_significant</span><span class="p">(</span><span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;S1&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;S1_conf&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">scaling</span><span class="o">*</span><span class="p">(</span><span class="n">SAresults</span><span class="p">[</span><span class="s2">&quot;S1&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="n">widthSc</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.4&#39;</span><span class="p">))</span>

    <span class="c1"># add labels</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">varNameMult</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">varNameMult</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">90</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">group_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">angles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">group</span><span class="p">]])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">gpNameMult</span><span class="o">*</span><span class="n">radSc</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">group_angle</span><span class="p">),</span> <span class="n">gpNameMult</span><span class="o">*</span><span class="n">radSc</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">group_angle</span><span class="p">),</span> <span class="n">group</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=</span><span class="n">group_angle</span><span class="o">*</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">90</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">radSc</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">radSc</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">radSc</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">radSc</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># define groups for parameter uncertainties</span>
<span class="n">groups</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Soil Moisture&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Huz&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Routing&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Alp&quot;</span><span class="p">,</span> <span class="s2">&quot;Kq&quot;</span><span class="p">,</span> <span class="s2">&quot;Ks&quot;</span><span class="p">]}</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">grouped_radial</span><span class="p">(</span><span class="n">Si</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Soil</span> <span class="n">Moisture</span>
<span class="n">Routing</span>
</pre></div>
</div>
<img alt="_images/hymod6.png" src="_images/hymod6.png" />
<p>2.4 Time-Varying Sensitivity Analysis</p>
<p id="time">In section 2.5 we saw how performing sensitivity analysis on different
measurements of model output can yield in different results on the
importance of each uncertain input. In this section we’ll examine how
performing this analysis over time can yield additional insight into the
performance of HYMOD. We’ll first examine how model sensitivities vary
by month, then examine how they change across each year of the
simulation.</p>
<p>For this demonstration, we’ll focus only on the monthly streamflow
predictions generated by HYMOD.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># aggregate simulated streamflow data to monthly time series</span>
<span class="n">df_sim_by_mth_mean</span> <span class="o">=</span> <span class="n">Q_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)[</span><span class="n">sample_column_names</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># aggregate observed streamflow data to monthly time series</span>
<span class="n">df_obs_by_mth_mean</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>We can use the following to calculate the SA indices for each month and
visualize it. Results are pre-loaded for efficiency.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up dataframes to store outputs</span>
<span class="n">df_mth_s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>
<span class="n">df_mth_delta</span> <span class="o">=</span> <span class="n">df_mth_s1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># iterate through each month</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>

    <span class="c1"># generate the simulation data</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df_sim_by_mth_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># run SA</span>
    <span class="n">Si</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem_hymod</span><span class="p">,</span> <span class="n">param_values_hymod</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">print_to_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># add to output dataframes</span>
    <span class="n">df_mth_s1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">df_mth_delta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># convert to arrays</span>
<span class="n">arr_mth_s1</span> <span class="o">=</span> <span class="n">df_mth_s1</span><span class="o">.</span><span class="n">values</span>
<span class="n">arr_mth_delta</span> <span class="o">=</span> <span class="n">df_mth_delta</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<p>The following can be used to visualize the time-varying first-order
indices. The first order represents the direct impacts of a specific
parameter on model outputs.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-monthly-heatmap">plot_monthly_heatmap</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load previously ran data</span>
<span class="n">arr_mth_delta</span><span class="p">,</span> <span class="n">arr_mth_s1</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">load_hymod_monthly_simulations</span><span class="p">()</span>

<span class="c1"># plot figure</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_monthly_heatmap</span><span class="p">(</span><span class="n">arr_sim</span><span class="o">=</span><span class="n">arr_mth_s1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                             <span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_by_mth_mean</span><span class="p">,</span>
                                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;First Order - Mean Monthly SA&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod7.png" src="_images/hymod7.png" />
<p>This figure demonstrates the first order sensitivity indices when the
streamflow data are aggregated by month. The purple line represents the
observed monthly discharge. The figure indicates that the first order
indices are highest for B and Huz across all months and lowest for Alp,
Ks, and Kq. Note that in the months with the highest flow, Ks becomes an
influential parameter.</p>
<p>We can also focus on the total order sensitivity index that includes
first-order SA indices and interactions between parameters</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot figure</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_monthly_heatmap</span><span class="p">(</span><span class="n">arr_sim</span><span class="o">=</span><span class="n">arr_mth_delta</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                       <span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_by_mth_mean</span><span class="p">,</span>
                                       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total Order - Mean monthly SA&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod8.png" src="_images/hymod8.png" />
<p>Notably, the total order sensitivity results are different than the
first order sensitivity results, which indicates that interactions
between the parameters (particularly in regards to routing parameters
<span class="math notranslate nohighlight">\(Kq\)</span>, <span class="math notranslate nohighlight">\(Ks\)</span>, and <span class="math notranslate nohighlight">\(Alp\)</span>) contribute to changes in HYMOD
output.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># group by year and get mean</span>
<span class="n">df_sim_by_yr_mean</span> <span class="o">=</span> <span class="n">Q_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="n">sample_column_names</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># group input data and get mean</span>
<span class="n">df_obs_by_yr_mean</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>We can also calculate the sensitivity analysis indices for each
individual year. This will allow us to understand if model control
changes during different years. The following code first aggregates the
outputs to annual time steps, and then calculates the SA indices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up dataframes to store outputs</span>
<span class="n">df_yr_s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>
<span class="n">df_yr_delta</span> <span class="o">=</span> <span class="n">df_yr_s1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># iterate through each year</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>

    <span class="c1"># generate the simulation data</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df_sim_by_yr_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># run SA</span>
    <span class="n">Si</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem_hymod</span><span class="p">,</span> <span class="n">param_values_hymod</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">print_to_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># add to output dataframes</span>
    <span class="n">df_yr_s1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">df_yr_delta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># convert to arrays</span>
<span class="n">arr_yr_s1</span> <span class="o">=</span> <span class="n">df_mth_s1</span><span class="o">.</span><span class="n">values</span>
<span class="n">arr_yr_delta</span> <span class="o">=</span> <span class="n">df_mth_delta</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-annual-heatmap">plot_annual_heatmap</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load previously ran data</span>
<span class="n">arr_yr_delta</span><span class="p">,</span> <span class="n">arr_yr_s1</span> <span class="o">=</span> <span class="n">load_hymod_annual_simulations</span><span class="p">()</span>

<span class="c1"># plot figure</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_annual_heatmap</span><span class="p">(</span><span class="n">arr_sim</span><span class="o">=</span><span class="n">arr_yr_s1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_by_yr_mean</span><span class="p">,</span>
                                            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;First Order - Mean Annual SA&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod9.png" src="_images/hymod9.png" />
<p>The first order sensitivities at the annual scale are not unlike the
first order monthly sensitivities. Once again, sensitivities vary across
year and Huz and B are the most consequential parameters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot figure</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_annual_heatmap</span><span class="p">(</span><span class="n">arr_sim</span><span class="o">=</span><span class="n">arr_yr_delta</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_by_yr_mean</span><span class="p">,</span>
                                            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total Order - Mean Annual SA and Observed flow&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod10.png" src="_images/hymod10.png" />
<p>Our results indicate that sensitivity analysis indices vary in different
years and now that interactions are included, the Kq, Ks, and Alp
variables impact the sensitivity of the streamflow output.</p>
<p>Although time-varying sensitivity analysis (TVSA) at average monthly and
average annual temporal resolutions is informative, TVSA is susceptible
to the aggregation issue that we discussed earlier in section 3-2. To
avoid that we can further discretize our time domain to zoom into
individual months. This will provide us with even more information about
model behavior and the sensitivity of different parameters in different
states of the system. The block of code demonstrates how to implement
the monthly TVSA.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up dataframes to store outputs</span>
<span class="n">df_vary_s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">df_obs_mth_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">)),</span>
                          <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Kq&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Alp&#39;</span><span class="p">,</span> <span class="s1">&#39;Huz&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>

<span class="n">df_vary_delta</span> <span class="o">=</span> <span class="n">df_vary_s1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># iterate through each month</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_obs_mth_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

    <span class="c1"># generate the simulation data</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df_sim_mth_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># run SA</span>
    <span class="n">Si</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem_hymod</span><span class="p">,</span> <span class="n">param_values_hymod</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">print_to_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># add to output dataframes</span>
    <span class="n">df_vary_s1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">df_vary_delta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># convert to arrays</span>
<span class="n">arr_vary_s1</span> <span class="o">=</span> <span class="n">df_vary_s1</span><span class="o">.</span><span class="n">values</span>
<span class="n">arr_vary_delta</span> <span class="o">=</span> <span class="n">df_vary_delta</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>View the source code used to create this plot here: <a class="reference external" href="https://uc-ebook.org/docs/html/A3_plotting_code.html#plot-varying-heatmap">plot_varying_heatmap</a></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load in previously ran data</span>
<span class="n">arr_vary_delta</span><span class="p">,</span> <span class="n">arr_vary_s1</span> <span class="o">=</span> <span class="n">load_hymod_varying_simulations</span><span class="p">()</span>

<span class="c1"># plot figure</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_varying_heatmap</span><span class="p">(</span><span class="n">arr_sim</span><span class="o">=</span><span class="n">arr_vary_s1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                             <span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_mth_mean</span><span class="p">,</span>
                                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;First Order - Time-Varying SA&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod11.png" src="_images/hymod11.png" />
<p>Compared to the TVSA when streamflow was aggregated, this figure
suggests that Kq is indeed a relevant parameter for influencing
streamflow output when individual months are considered.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot figure</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_varying_heatmap</span><span class="p">(</span><span class="n">arr_sim</span><span class="o">=</span><span class="n">arr_vary_delta</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                             <span class="n">df_obs</span><span class="o">=</span><span class="n">df_obs_mth_mean</span><span class="p">,</span>
                                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total Order - Time-Varying SA&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hymod12.png" src="_images/hymod12.png" />
<p>As above, the total order sensitivities further indicate the importance
of Kq that is not apparent if aggregation is utilized.</p>
</section>
<section id="tips-to-apply-this-methodology-to-your-own-problem">
<h3><span class="section-number">B.4.4. </span>Tips to Apply this methodology to your own problem<a class="headerlink" href="#tips-to-apply-this-methodology-to-your-own-problem" title="Link to this heading">#</a></h3>
<p>In this tutorial, we demonstrated how to use global sensitivtiy analysis
to explore a complex, non-linear model. We showed how measuring
sensitivity across multiple measures of model performance and temporal
aggregations yielding differing results about model
sensitivity/behavoir. While these results may seem contraditory, they
provide useful insight into the behavoir of HYMOD. Would we expect the
same parameters to control high flow and low flow regimes within the
model? Maybe, depending on the system, but also, maybe not. This
analysis can provide insight into how the model responds to its input
parameters, allowing us to compare the results to our expectaions. This
may allow us to find problems with our intial assumptions, or call
attention to model features that can be improved or expanded upon.
Depending on the model and context, it may also yield insight into the
workings of the underlying system.</p>
<p>To run this tutorial on your own model you will need to:</p>
<ol class="arabic simple">
<li><p>Design your experiment by choosing sampling bounds for your
parameters and setting up the problem dictionary as in step 2-2</p></li>
<li><p>Choose the parameters of interest</p></li>
<li><p>Generate samples using the saltelli.sample function. This step is
problem-dependent and note that the Sobol method can be
computationally intensive depending on the model being analyzed. More
complex models will be slower to run and will also require more
samples to calculate accurate estimates of Sobol indices. Once you
complete this process, pay attention to the confidence bounds on your
sensitivity indices to see whether you need to run more samples.</p></li>
<li><p>Run the parameter sets through your model and record each of the
desired model outputs.</p></li>
<li><p>Calculate the Sobol indices for each performance criteria. Now, the Y
will be a numpy array with your external model output and you will
need to include the parameter samples as an additional argument.</p></li>
<li><p>Follow the procedure in step 2.6 to disaggregate performance across
time</p></li>
</ol>
</section>
</section>
<section id="time-evolving-scenario-discovery-for-infrastructure-pathways">
<h2><span class="section-number">B.5. </span>Time-evolving scenario discovery for infrastructure pathways<a class="headerlink" href="#time-evolving-scenario-discovery-for-infrastructure-pathways" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/Bedford_Greene_SD_tutorial.ipynb">Scenario Discovery Notebook</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<section id="id24">
<h3><span class="section-number">B.5.1. </span>Time-evolving scenario discovery for infrastructure pathways<a class="headerlink" href="#id24" title="Link to this heading">#</a></h3>
<p>The purpose of this tutorial is to explore time-evolving vulnerability for systems that dynamically adapt to changing conditions. Using an example from water supply planning, we’ll first examine how performance of a dynamic infrastructure pathway policy changes over time, then use factor mapping (main text Chapter 4.3) to understand which combinations of uncertainties generate vulnerability for two water utilities. Next, we’ll perform factor prioritization (main text Chapter 4.3) to determine which uncertainties have the most influence on water supply performance. Finally, we’ll provide an open platform to explore vulnerability across multiple measures of performance and different combinations of uncertainties.</p>
<section id="id25">
<h4><span class="section-number">B.5.1.1. </span>Background<a class="headerlink" href="#id25" title="Link to this heading">#</a></h4>
<p>The Bedford-Greene metropolitan area (Figure 1) is a stylized water resources test case where two urban water utilities seek to develop an infrastructure and investment and management strategy to confront growing demands and changing climate. The utilities have agreed to jointly construct a new water treatment plant on Lake Classon, a large regional resource. Both utilities have also identified a set of individual infrastructure options to construct if necessary.</p>
<figure class="align-default" id="id35">
<img alt="Figure 1" src="_images/Map_small.png" />
<figcaption>
<p><span class="caption-number">Fig. B.1 </span><span class="caption-text">Figure 1</span><a class="headerlink" href="#id35" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The utilities are formulating a cooperative and adaptive regional management strategy that uses a risk-of-failure (ROF) metric to trigger both short term drought mitigation actions (water use restrictions and treated transfers between utilities) and long-term infrastructure investment decisions (shown in Figure 2a). Both utilities have specified a set of risk triggers and developed a construction order for available infrastructure options.</p>
<p>The utilities have run a Monte Carlo simulation to evaluate how these policies respond to a wide array of future States Of the World (SOWs). Each SOW represents a different combinations of thirteen uncertain system inputs including demand growth rates, changes to streamflows and financial variables. In this context, a fully specified SOW is composed of one sample of uncertain model inputs (e.g. one projection of demand growth rate coupled with one future streamflow scenario and one projection of future financial conditions). The water utilities used Latin Hypercube sampling (Chapter 3.3 of the main text) to develop an ensemble of 1,000 plausible future SOWs. The Monte Carlo simulation evaluates each candidate water supply infrastructure investment and management policy across all 1,000 SOWs, as shown in Figure 2b. For more details on the Monte Carlo sampling for this type  of analysis, see Trindade et al., (2019).</p>
<p>The ROF-based policies respond to each SOW by generating a unique infrastructure pathway - a sequence of infrastructure investment decisions over time. Infrastructure pathways over a set of 1,000 future SOWs are shown in Figure 2c. Infrastructure options are arrayed along the vertical axis and the sequence of infrastructure investments triggered by the policy is plotted as pathways over time.  Since the adaptive rule system generates a unique infrastructure sequence for each scenario, Figure 2c summarizes the ensemble of pathways by clustering SOWs according to infrastructure intensity. Dark green lines represent SOWs where the utilities heavily invest in new infrastructure, light green lines represent SOWs with low infrastructure investment and medium shaded lines represent moderate investment. The shading behind each pathway represents the frequency that each infrastructure option was triggered over time across sampled scenarios</p>
<figure class="align-default" id="id36">
<img alt="Figure 2" src="_images/Policy_MonteCarlo_Pathways_small.png" />
<figcaption>
<p><span class="caption-number">Fig. B.2 </span><span class="caption-text">Figure 2</span><a class="headerlink" href="#id36" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="evaluating-robustness-over-time">
<h4><span class="section-number">B.5.1.2. </span>Evaluating Robustness over time<a class="headerlink" href="#evaluating-robustness-over-time" title="Link to this heading">#</a></h4>
<p>The two water utilities are interested in maintaining both supply
reliability and financial stability across the broadest set of plausible
future SOWs. To measure the performance of the infrastructure pathway
policy, they’ve defined five critical performance criteria:</p>
<ul class="simple">
<li><p>Reliability &gt; 99%</p></li>
<li><p>Restriction Frequency &lt; 20%</p></li>
<li><p>Peak Financial Cost &lt; 80% of annual revenue (a measure of debt
service spending)</p></li>
<li><p>Worst-case drought management cost &lt; 10% of annual revenue (a measure
of unexpected drought costs)</p></li>
<li><p>Unit Cost of Expansion &lt; 5 dollars/kgal</p></li>
</ul>
<p>To assess the robustness of the infrastructure pathway policy, the two
utilities apply a satisficing metric, which measures the percentage of
sampled SOWs where the pathway policy meets the performance criteria:</p>
<p><span class="math notranslate nohighlight">\(R =\frac{1}{N}\sum_{j=1}^{N}\Lambda_{\theta,j}\)</span></p>
<p>Where, <span class="math notranslate nohighlight">\(\Lambda\_{\theta,j}=\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
1, \quad \textrm{if}\ F(\theta)_{j}\leq \Phi_j \\
0, \quad \textrm{otherwise}
\end{cases}\end{split}\]</div>
<p>And <span class="math notranslate nohighlight">\(\Phi\)</span> is a vector of performance criteria for utility
<span class="math notranslate nohighlight">\(j\)</span>, <span class="math notranslate nohighlight">\(\theta\)</span> is the portfolio and <span class="math notranslate nohighlight">\(N\)</span> is the total
number of sampled SOWs.</p>
<p>Below, we’ll visualize how robustness for the two utilities evolves over the 45-year planning horizon. We’ll assess robustness across three time periods, near-term (first 10 years), mid-term (22 years) and long term (45 years).</p>
<p>We start by loading robustness values for the both utilities. These values are calculated by applying the robustness metric above across 2,000 simulated SOWs. To make this exercise computationally tractable, we’ve precomputed these values, which can be found in the files “short_term_robustness.csv”, “mid_term_robustness.csv” and “long_term_robustness.csv”. These values are calculated using the function “check_rdm_meet_criteria” within the helper functions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functions.eBook_SD_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_rdm_meet_criteria</span><span class="p">,</span> <span class="n">create_sd_input</span><span class="p">,</span> <span class="n">plot_selected_tree_maps</span><span class="p">,</span> <span class="n">get_factor_importances</span><span class="p">,</span> <span class="n">open_exploration</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="c1"># load Deeply uncertain factors</span>
<span class="n">rdm_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/DU_Factors.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="n">short_term_robustness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/short_term_robustness.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">mid_term_robustness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/mid_term_robustness.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">long_term_robustness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/long_term_robustness.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="c1"># plot robustness over time</span>
<span class="n">fig</span> <span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#B19CD9&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span> <span class="s1">&#39;#43b284&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#B19CD9&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#43b284&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time Horizon (yrs)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Robustness (% SOWs)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Bedford&#39;</span><span class="p">,</span> <span class="s1">&#39;Greene&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Robustness Over Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">107</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">107.0</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/discovery_4_1.png" src="_images/discovery_4_1.png" />
</section>
<section id="exploring-performance-evolution">
<h4><span class="section-number">B.5.1.3. </span>Exploring performance evolution<a class="headerlink" href="#exploring-performance-evolution" title="Link to this heading">#</a></h4>
<p>The figure above reveals that the robustness of both water utilities degrades over time, with Bedford’s robustness declining further than Greene. This suggests that the proposed pathway policy is likely insufficient to meet the long-term needs of the two utilities. But how is the current policy insufficient? To answer that question we examine the performance measures that fail to meet performance criteria for each utility across the three planning horizons.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the type of vulnerability over time</span>

<span class="c1">### Bedford ###</span>
<span class="n">plot_robustness_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="c1"># Determine the percentage of failure SOWs that violate each criterion (note some SOWS fail multiple criteria, so this may some to &gt;1)</span>
<span class="n">criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Reliability&#39;</span><span class="p">,</span> <span class="s1">&#39;Restriction Frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;Peak Financial Cost&#39;</span><span class="p">,</span> <span class="s1">&#39;Worst-case drought</span><span class="se">\n</span><span class="s1">Management Cost&#39;</span><span class="p">,</span> <span class="s1">&#39;Stranded Assets&#39;</span><span class="p">]</span>
<span class="n">plot_robustness_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plot_robustness_1</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plot_robustness_1</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

<span class="c1"># Plot over time</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">plot_robustness_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#B19CD9&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;10-year Horizon&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of failure SOWs&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">plot_robustness_1</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#B19CD9&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;22-year Horizon&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">plot_robustness_1</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#B19CD9&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;45-year Horizon&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bedford&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1">### Greene ###</span>
<span class="c1"># Determine the percentage of failure SOWs that violate each criterion (note some SOWS fail multiple criteria, so this may some to &gt;1)</span>
<span class="n">plot_robustness_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">plot_robustness_2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">short_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
<span class="n">plot_robustness_2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mid_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
<span class="n">plot_robustness_2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">long_term_robustness</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">plot_robustness_2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#43b284&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;10-year Horizon&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of failure SOWs&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">plot_robustness_2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#43b284&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;22-year Horizon&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">plot_robustness_2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#43b284&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;45-year Horizon&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Greene&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/discovery_6_0.png" src="_images/discovery_6_0.png" />
<img alt="_images/discovery_6_1.png" src="_images/discovery_6_1.png" />
<p>In the figures above, we observe that the vulnerability of both utilities changes in different ways. Early in the simulation period, Bedford is vulnerable to failures in reliability (though the robustness figure created in step B5.2 reveals that these failures are very rare). As the simulation period progresses, Bedford’s vulnerability expands to include failures in restriction frequency and worst-case cost. These failures indicate that the utility has an overall inability to manage drought conditions and future conditions progress.</p>
<p>Greene shows a very different evolution in vulnerability. Early in the simulation period, failures manifest in the restriction frequency objective, suggesting that the utility must rely on water use restrictions to maintain supply reliability. As the simulation progresses however, the vulnerability evolves. When evaluated across the 45-year planning horizon, a new failure modes emerges - financial failure manifesting in peak financial cost and stranded assets. This suggests that the proposed pathway policy may be over-investing in new infrastructure, straining the utility’s budget with large debt payments that are unnecessary to maintain supply reliability.</p>
</section>
<section id="how-do-deep-uncertainties-generate-vulnerability">
<h4><span class="section-number">B.5.1.4. </span>How do deep uncertainties generate vulnerability<a class="headerlink" href="#how-do-deep-uncertainties-generate-vulnerability" title="Link to this heading">#</a></h4>
<p>While the evolution of robustness provides insight into how the system
evolves over time, it does not reveal <em>why</em> each utility is vulnerable.
To examine how deep uncertainties generate vulnerability over time for
the two utilities, we perform scenario discovery (factor mapping,
Chapter 4.3). Here we’ll utilize gradient boosted trees to identify
regions of the uncertainty space that cause the utilities to fail to
meet performance criteria.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import the performance data across 2000 SOWs for three time periods</span>
<span class="n">short_term_performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/short_term_performance.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">mid_term_performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/mid_term_performance.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">long_term_performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/long_term_performance.csv&#39;</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="n">satisficing_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">.2</span><span class="p">,</span> <span class="mf">.8</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1"># transform into scenario discovery input</span>
<span class="n">short_term_SD_input</span> <span class="o">=</span> <span class="n">create_sd_input</span><span class="p">(</span><span class="n">short_term_performance</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">)</span>
<span class="n">mid_term_SD_input</span> <span class="o">=</span> <span class="n">create_sd_input</span><span class="p">(</span><span class="n">mid_term_performance</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">)</span>
<span class="n">long_term_SD_input</span> <span class="o">=</span> <span class="n">create_sd_input</span><span class="p">(</span><span class="n">long_term_performance</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">)</span>

<span class="c1"># factor mapping Bedford</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plot_selected_tree_maps</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;short_term&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;10-year Horizon&#39;</span><span class="p">)</span>
<span class="n">plot_selected_tree_maps</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;mid_term&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;22-year Horizon&#39;</span><span class="p">)</span>
<span class="n">plot_selected_tree_maps</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;long_term&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;45-year Horizon&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bedford Factor Maps&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># factor mapping Greene</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plot_selected_tree_maps</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;short_term&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;10-year Horizon&#39;</span><span class="p">)</span>
<span class="n">plot_selected_tree_maps</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;mid_term&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;22-year Horizon&#39;</span><span class="p">)</span>
<span class="n">plot_selected_tree_maps</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;long_term&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">satisficing_criteria</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;45-year Horizon&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Greene Factor Maps&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Bedford</span>
<span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Bedford</span>
<span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Bedford</span>
</pre></div>
</div>
<img alt="_images/discovery_9_1.png" src="_images/discovery_9_1.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Greene</span>
<span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Greene</span>
<span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Greene</span>
</pre></div>
</div>
<img alt="_images/discovery_9_2.png" src="_images/discovery_9_2.png" />
<p>In the figures above, we learn more about how the vulnerability of the two utilities evolves over time. Bedford begins with very few possible failures but appears vulnerable to high demand growth scenarios under future scenarios with high demands. When evaluated across a 22-year planning horizon, Bedford is vulnerable when the near-term demand growth is high and water use restrictions are less effective than predicted. Under the full 45-year planning horizon, Bedford is vulnerable to sustained high levels of demand growth, failing if either near-term or mid-term demand growth exceeds expected levels.</p>
<p>Greene’s vulnerability evolves differently. It begins with vulnerability to high demand growth, but as the simulation progresses (and infrastructure is constructed), the utility becomes vulnerable to low-demand growth futures which cause the failures in financial criteria shown in section B.5.3. This indicates that the pathway policy over-builds in many SOWs, and becomes financially unstable if demand does not grow sufficiently to provide revenue to cover debt service payments.</p>
</section>
<section id="which-uncertainties-have-the-most-influence-on-time-evolving-performance">
<h4><span class="section-number">B.5.1.5. </span>Which uncertainties have the most influence on time-evolving performance?<a class="headerlink" href="#which-uncertainties-have-the-most-influence-on-time-evolving-performance" title="Link to this heading">#</a></h4>
<p>The factor maps generated in B.5.4 present the vulnerability generated by the two most important deep uncertainties as determined by Gradient Boosted Trees. Yet the factor prioritization shows that more than two uncertainties are influential to regional performance. Further, we can observe that individual uncertainties have different impacts on each performance objective, and these impacts may change over time. In the cells below, explore the impact of deep uncertainty by generating factor maps for different combinations of deep uncertain factors, objectives and time horizons.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">uncertainties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">,</span> <span class="s1">&#39;D3&#39;</span><span class="p">,</span> <span class="s1">&#39;BT&#39;</span><span class="p">,</span> <span class="s1">&#39;BM&#39;</span><span class="p">,</span> <span class="s1">&#39;DR&#39;</span><span class="p">,</span> <span class="s1">&#39;RE&#39;</span><span class="p">,</span> <span class="s1">&#39;EV&#39;</span><span class="p">,</span> <span class="s1">&#39;PM&#39;</span><span class="p">,</span> <span class="s1">&#39;CT&#39;</span><span class="p">,</span> <span class="s1">&#39;IA&#39;</span><span class="p">,</span> <span class="s1">&#39;IF&#39;</span><span class="p">,</span> <span class="s1">&#39;IP&#39;</span><span class="p">]</span>
<span class="n">uncertainties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Near-term demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Mid-term demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Long-term demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Bond Term&#39;</span><span class="p">,</span> <span class="s1">&#39;Bond Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Discount Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Restriction Effectiveness&#39;</span><span class="p">,</span> <span class="s1">&#39;Evaporation Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Permitting time&#39;</span><span class="p">,</span> <span class="s1">&#39;Construction time&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflow Amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflow Frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflow Period&#39;</span><span class="p">]</span>

<span class="n">u1_st_FI</span> <span class="o">=</span> <span class="n">get_factor_importances</span><span class="p">(</span><span class="n">short_term_SD_input</span><span class="p">,</span> <span class="n">rdm_factors</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">u1_mt_FI</span> <span class="o">=</span> <span class="n">get_factor_importances</span><span class="p">(</span><span class="n">mid_term_SD_input</span><span class="p">,</span> <span class="n">rdm_factors</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">u1_lt_FI</span> <span class="o">=</span> <span class="n">get_factor_importances</span><span class="p">(</span><span class="n">long_term_SD_input</span><span class="p">,</span> <span class="n">rdm_factors</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">u1_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">u1_st_FI</span><span class="p">,</span><span class="n">u1_mt_FI</span><span class="p">,</span> <span class="n">u1_lt_FI</span><span class="p">])</span>
<span class="n">u1_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u1_all</span><span class="p">)</span>

<span class="c1"># factor ranking -- utility 2</span>
<span class="n">u2_st_FI</span> <span class="o">=</span> <span class="n">get_factor_importances</span><span class="p">(</span><span class="n">short_term_SD_input</span><span class="p">,</span> <span class="n">rdm_factors</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">u2_mt_FI</span> <span class="o">=</span> <span class="n">get_factor_importances</span><span class="p">(</span><span class="n">mid_term_SD_input</span><span class="p">,</span> <span class="n">rdm_factors</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">u2_lt_FI</span> <span class="o">=</span> <span class="n">get_factor_importances</span><span class="p">(</span><span class="n">long_term_SD_input</span><span class="p">,</span> <span class="n">rdm_factors</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">u2_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">u2_st_FI</span><span class="p">,</span><span class="n">u2_mt_FI</span><span class="p">,</span> <span class="n">u2_lt_FI</span><span class="p">])</span>
<span class="n">u2_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u2_all</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">cax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
                  <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]})</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u1_all</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">uncertainties</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Horizon&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bedford&#39;</span><span class="p">)</span>

<span class="n">im1</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u2_all</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Horizon&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Greene&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Factor Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/discovery_12_0.png" src="_images/discovery_12_0.png" />
<p>The Figure above shows the factor importance as determined by gradient boosted trees for both utilities across the three planning horizons. While near-term demand growth is important for both utilities under all three planning horizons, the importance of other factors evolves over time. For example, restriction effectiveness plays an important role for Greene under the 22-year planning horizon but disappears under the 45-year planning horizon. In contrast, the bond interest rate is important for predicting success over the 45-year planning horizon, but does not appear important over the 10- or 22-year planning horizons. These findings highlight how assumptions about the planning period can have a large impact on modeling outcomes.</p>
</section>
<section id="open-exploration">
<h4><span class="section-number">B.5.1.6. </span>Open exploration<a class="headerlink" href="#open-exploration" title="Link to this heading">#</a></h4>
<p>In the cell below, use the function to explore how factor maps change
for the two utilities based upon the uncertainties plotted, the
objectives of interest and the time horizon.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># specify the utility (&quot;Bedford&quot; or &quot;Greene&quot;)</span>
<span class="n">utility</span> <span class="o">=</span> <span class="s2">&quot;Bedford&quot;</span>

<span class="c1"># specify which performance objectives to investigate (note that not all performance objectives have failures, which may result in a blank factor map)</span>
<span class="c1"># set this to one of the following: &quot;Reliability&quot;, &quot;Restriction Frequency&quot;, &quot;Peak Financial Cost&quot;, &quot;Worst Case Cost&quot; or &quot;Unit Cost&quot;</span>
<span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;Reliability&quot;</span>

<span class="c1"># select uncertainties from the following list: &#39;D1&#39;, &#39;D2&#39;, &#39;D3&#39;, &#39;BT&#39;, &#39;BM&#39;, &#39;DR&#39;, &#39;RE&#39;, &#39;EV&#39;, &#39;PM&#39;, &#39;CT&#39;, &#39;IA&#39;, &#39;IF&#39;, &#39;IP&#39;</span>
<span class="n">uncertainty_1</span> <span class="o">=</span> <span class="s1">&#39;D1&#39;</span>
<span class="n">uncertainty_2</span> <span class="o">=</span> <span class="s1">&#39;D2&#39;</span>

<span class="c1"># The code below will plot factor maps over the three planning horizons for the information above</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">open_exploration</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="s1">&#39;short_term&#39;</span><span class="p">,</span> <span class="n">uncertainty_1</span><span class="p">,</span> <span class="n">uncertainty_2</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">open_exploration</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="s1">&#39;mid_term&#39;</span><span class="p">,</span> <span class="n">uncertainty_1</span><span class="p">,</span> <span class="n">uncertainty_2</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">open_exploration</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="s1">&#39;long_term&#39;</span><span class="p">,</span> <span class="n">uncertainty_1</span><span class="p">,</span> <span class="n">uncertainty_2</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Bedford</span><span class="p">,</span> <span class="n">reliability</span>
<span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Bedford</span><span class="p">,</span> <span class="n">reliability</span>
<span class="n">Factor</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">Bedford</span><span class="p">,</span> <span class="n">reliability</span>
</pre></div>
</div>
<img alt="_images/discovery_16_1.png" src="_images/discovery_16_1.png" />
</section>
<section id="id26">
<h4><span class="section-number">B.5.1.7. </span>Tips to apply this methodology to your own problem<a class="headerlink" href="#id26" title="Link to this heading">#</a></h4>
<p>In this tutorial, we demonstrated time-evolving scenario discovery for a
cooperative water supply system. To apply this workflow to your own
problem:</p>
<ol class="arabic simple">
<li><p>Choose sampling bounds for your parameters of interest, which will
represent uncertainties that characterize your system.</p></li>
<li><p>Generate samples for these parameters (this can be done using the
saltelli.sample function as in B.2 or done with another package).</p></li>
<li><p>Define performance criteria for your problem</p></li>
<li><p>Evaluate parameter sets through your model, and save performance
measures across multiple time horizons</p></li>
<li><p>Draw from the supporting code for this tutorial to perform scneario
discovery and visualize results</p></li>
</ol>
</section>
<section id="references">
<h4><span class="section-number">B.5.1.8. </span>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h4>
<p>Trindade, B. C., Reed, P. M., &amp; Characklis, G. W. (2019). Deeply uncertain pathways: Integrated multi-city regional water supply infrastructure investment and portfolio management. Advances in Water Resources, 134, 103442.</p>
</section>
</section>
</section>
<section id="a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios-tutorial">
<h2><span class="section-number">B.6. </span>A Hidden-Markov Modeling Approach to Creating Synthetic Streamflow Scenarios Tutorial<a class="headerlink" href="#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios-tutorial" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/Hidden-Markov_Modeling_Approaches_to_Creating_Synthetic_Streamflow_Scenarios.ipynb">HMM Notebook</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<section id="a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios">
<h3><span class="section-number">B.6.1. </span>A Hidden-Markov Modeling Approach to Creating Synthetic Streamflow Scenarios<a class="headerlink" href="#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios" title="Link to this heading">#</a></h3>
<p>In this notebook, we will be covering the basics of fitting a Hidden
Markov Model-based synthetic streamflow generator for a single site in
the Upper Colorado River Basin. First, we will characterize the observed
historical flow in the basin from 1909-2013. Then, we will fit a
synthetic streamflow generator to the observed flows in the basin in
order to create stationary synthetic flows. Finally, we will create a
non-stationary version of the generator to create flows that could be
representative of plausible future climate in the region. We ultimately
show how to place the synthetically generated flows in the context of
physically-informed CMIP5 projections to compare the two methods.</p>
<section id="id29">
<h4><span class="section-number">B.6.1.1. </span>Background<a class="headerlink" href="#id29" title="Link to this heading">#</a></h4>
<p>In the Western United States (US), and particularly the Colorado River
Basin, a recent study used tree-ring reconstructions to suggest that the
megadrought that has been occurring in the Southwest over the past 22
years is the region’s worst drought since about 800 AD (Williams et al.,
2022). The study’s lead author, UCLA climatologist Park Williams,
suggested that had the sequence of wet-dry years occurred without
anthropogenic forcing, the 2000s would have likely still been dry, but
not on the same level as the worst of the last millennium’s
megadroughts.</p>
<p>The recent trend of warming and reduced soil moisture in the Southwest
US is highly challenging from a water systems planning and management
perspective for the Colorado River Basin. Given the wide recognition
that the river is over-allocated, the most recent drought highlights the
difficulty of sustaining the flow requirements as dictated by the
Colorado Compact. Thus, there has been an increasing focus in
exploratory modeling efforts to clarify how vulnerable water systems in
this region are to plausible drought streamflow scenarios for the
future. In this tutorial, we’ll discuss how to create these scenarios
using a Hidden Markov Model (HMM)- based streamflow synthetic generator.
As discussed in <a class="reference external" href="https://uc-ebook.org/docs/html/2_diagnostic_modeling_overview_and_perspectives.html#overview-of-model-diagnostics">Section
2.1</a>
and
<a class="reference external" href="https://uc-ebook.org/docs/html/4_sensitivity_analysis_diagnostic_and_exploratory_modeling.html#consequential-dynamics-what-is-controlling-model-behaviors-of-interest">4.2</a>
of the eBook, future climate conditions in the basin represent a deep
uncertainty that can lead to highly consequential water scarcity
outcomes. It is advantageous to create a model such as the HMM-based
generator in order to facilitate the creation of many ensembles of
streamflow that can ultimately be used to force regional water systems
models to understand how variability and drought extremes affect
regional water shortages, operations, and policies.</p>
<figure>
<center><img src="_static/1-lede_pix_-_usbr-powell-8517152024_aa66437c2e_o-cropped.jpg" style="width:50%"></center>
<figcaption style="text-align:center"> Lake Powell shows persistent effects from drought (Source: U.S. Bureau of Reclamation) </figcaption>
</figure></section>
</section>
<section id="id31">
<h3><span class="section-number">B.6.2. </span>Let’s Get Started!<a class="headerlink" href="#id31" title="Link to this heading">#</a></h3>
<section id="observed-record">
<h4><span class="section-number">B.6.2.1. </span>Observed Record<a class="headerlink" href="#observed-record" title="Link to this heading">#</a></h4>
<p>First, let’s take a look at the observed data from 1909-2013 for a
specific site. In this example, we use the outlet gauge of the Upper
Colorado River (USGS Gauge 09163500 at the Colorado-Utah state line).
Below, we create a plot of the annual streamflow.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SALib.sample</span><span class="w"> </span><span class="kn">import</span> <span class="n">latin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">ss</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>

<span class="c1"># Import helper functions from local package</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">fitmodel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">plotstates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">plotdist</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in annual historical data</span>
<span class="n">AnnualQ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/uc_historical.csv&#39;</span><span class="p">)</span>
<span class="n">AnnualQ</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1909</span><span class="p">,</span> <span class="mi">2014</span><span class="p">))</span>

<span class="c1"># Plot a line graph</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#005F73&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Upper Colorado Annual Flow&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Annual Flow (cubic feet per year)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_9_0.png" src="_images/hmm_9_0.png" />
<p>Let’s calculate an 11-year rolling mean of the same data to get a sense of long-term trends.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the original line graph</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
         <span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#005F73&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>

<span class="c1"># Plot an 11-year rolling mean</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
         <span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#183A2E&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;11-Year Rolling Mean&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Upper Colorado Annual Flow&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Annual Flow (cubic feet per year)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_11_0.png" src="_images/hmm_11_0.png" />
<p>The Colorado Compact, which prescribes flows between the Upper and Lower
Colorado Basins, was negotiated using data prior to 1922, a time period
revealed by the above figure to be one of the consistently wetter
periods on record. It’s clear today that since the 1980s, the Southwest
US has been experiencing aridification (Overpeck et al., 2020) and that
this observed record alone isn’t an accurate representation of what
future climate might look like in this region.</p>
<p>Let’s get a little more specific and formally quantify decadal droughts
that have occurred in the observed period. We use a metric proposed in
Ault et al. (2014). The authors define a decadal drought as when the
11-year rolling mean falls below a threshold that is 1/2 a standard
deviation below the overall mean of the record. We can then highlight
the block of years that fall in a decadal drought using yellow
rectangles below.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define drought threshold</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>

<span class="c1"># Find where the rolling mean dip below the threshold?</span>
<span class="n">drought_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span>
<span class="n">drought_years</span> <span class="o">=</span> <span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">drought_instances</span><span class="p">]</span>

<span class="c1"># Add labels and title</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#005F73&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#183A2E&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;11-Year Rolling Mean&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
           <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Drought Threshold&#39;</span><span class="p">)</span>

<span class="c1"># Visualize the drought periods as yellow rectangles</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">drought_years</span><span class="p">:</span>

    <span class="c1"># Plot a box centered around those values and with 5 years on either side.</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">11</span><span class="p">,</span><span class="mf">2e7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#EFE2BE&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#EFE2BE&#39;</span><span class="p">)</span>

    <span class="c1"># Add the patch to the Axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Upper Colorado Annual Flow&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Annual Flow (cubic feet per year)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_14_0.png" src="_images/hmm_14_0.png" />
<p>By this metric, the Upper Colorado Basin region has experienced two
decadal droughts over the last century.</p>
</section>
<section id="synthetic-stationary-generator-to-better-quantify-natural-variability">
<h4><span class="section-number">B.6.2.2. </span>Synthetic Stationary Generator to Better Quantify Natural Variability<a class="headerlink" href="#synthetic-stationary-generator-to-better-quantify-natural-variability" title="Link to this heading">#</a></h4>
<p>It is important to remember that the streamflow that we have observed in
the region over the last century is only one instance of the hydrology
that could occur since the atmosphere is an inherently stochastic
system. Thus, we require a tool that will allow us to see multiple
plausible realizations of the streamflow record to understand the
internal variability that characterizes the historical period. One
observed realization of historical streamflow is limited in its ability
to capture rare extremes; plausible (but not observed) alternative
instances of streamflow records can help to fill this gap. The tool that
we use to develop synthetic flows for the region is a Gaussian Hidden
Markov Model (HMM). If a system follows a Markov process, it switches
between a number of “hidden states” dictated by a transition matrix.
Each state has its own Gaussian probability distribution (defined by a
mean and standard deviation) and one can draw from this distribution to
create synthetic flows that fit the properties of the historical
distribution. HMMs are an attractive choice for this region because they
can simulate persistence (i.e., long duration droughts), which is a
characteristic of the region’s hydro-climatology. The figure below shows
an example of a 2-state Gaussian HMM that we will be fitting for this
example.</p>
<figure>
    <center><img src="_static/HMM_example.png" style="width:75%"></center>
<figcaption style="text-align:center"> Two-state Gaussian HMM with mean and standard deviation parameters</figcaption>
</figure><p>Below is the code that fits the HMM model to the last 2/3 of the
historical record of log annual flows at the CO-UT stateline gauge and
creates an alternative trace of 105 years. A subset of the dataset is
chosen in order to minimize overfitting and to retain a set of data for
validation of the model. When we fit our model, we utilize the
Baum-Welch algorithm (a special version of the expectation-maximization
algorithm) to find the optimal parameters that maximize the likelihood
of seeing the observed flows. Ultimately, the algorithm will return a
mean and standard deviation associated with each state (mus and sigmas
defined below) and a 2x2 transition probability matrix that captures the
likelihood of transitioning between states (P). We can also retrieve the
annual hidden states across the observed series, also known as the
Viterbi sequence of states, which classifies each year in a “wet” or
“dry” state.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of years for alternative trace</span>
<span class="n">n_years</span> <span class="o">=</span> <span class="mi">105</span>

<span class="c1"># Import historical data that it used to fit HMM model</span>
<span class="n">AnnualQ_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/uc_historical.csv&#39;</span><span class="p">)</span>

<span class="c1"># Fit the model and pull out relevant parameters and samples</span>
<span class="n">logQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">AnnualQ_h</span><span class="p">)</span>
<span class="n">hidden_states</span><span class="p">,</span> <span class="n">mus</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">logProb</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">fitmodel</span><span class="o">.</span><span class="n">fitHMM</span><span class="p">(</span><span class="n">logQ</span><span class="p">,</span> <span class="n">n_years</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ve fit our HMM, but what does the model look like? Let’s plot the
annual time series of hidden states, or the Viterbi sequence. In the
code, above, we have defined that the drier state is always represented
by state 0. Thus, we know that hidden_states = 0 corresponds to the dry
state and hidden_states = 1 to the wet state.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot Vitebi sequence</span>
<span class="n">plotstates</span><span class="o">.</span><span class="n">plotTimeSeries</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">AnnualQ</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="s1">&#39;Annual Flow (cube feet per year)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hmm_21_0.png" src="_images/hmm_21_0.png" />
<p>In the figure above, we see that the years with the higher log flows
tend to be classified in a “wet” state and the opposite is true of the
“dry” state. We can also print the transition matrix, which shows the
likelihood of transitioning between states. Note that the system has a
high likelihood of persisting in the same state.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transmat_</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="mf">0.65095026</span> <span class="mf">0.34904974</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.3205531</span>  <span class="mf">0.6794469</span> <span class="p">]]</span>
</pre></div>
</div>
<p>Let’s also plot the distribution of log annual flows associated with the
wet and dry states.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot wet and dry state distributions</span>
<span class="n">plotdist</span><span class="o">.</span><span class="n">plotDistribution</span><span class="p">(</span><span class="n">logQ</span><span class="p">,</span> <span class="n">mus</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/hmm_25_0.png" src="_images/hmm_25_0.png" />
<p>The wet state distribution is characterized by a greater mean flow, but
note that there is significant overlap in the tails of the distributions
below which demonstrates why years with similiar flows can be classified
in different states.</p>
<p>Now let’s see what the drought dynamics look like in the synthetic
scenario that we created using the same definition that we had used for
the historical period.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve samples and back-transform out of log space</span>
<span class="n">AnnualQ_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">AnnualQ_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="p">)</span>
<span class="n">AnnualQ_s</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1909</span><span class="p">,</span> <span class="mi">2014</span><span class="p">))</span>

<span class="c1"># Define drought threshold</span>
<span class="n">std</span><span class="o">=</span><span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>

<span class="c1"># Where does the rolling mean dip below the threshold</span>
<span class="n">drought_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span>
<span class="n">drought_years</span> <span class="o">=</span> <span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">drought_instances</span><span class="p">]</span>

<span class="c1"># Visualize the streamflow scenario</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the original line graph</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#005F73&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>

<span class="c1"># Plot a 11-year rolling mean</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#183A2E&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;11-Year Rolling Mean&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
           <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Drought Threshold&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">drought_years</span><span class="p">:</span>

    <span class="c1"># Plot a box centered around those values and with 5 years on either side.</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                              <span class="mi">0</span><span class="p">),</span>
                              <span class="mi">11</span><span class="p">,</span>
                              <span class="mf">2e7</span><span class="p">,</span>
                              <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#EFE2BE&#39;</span><span class="p">,</span>
                              <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#EFE2BE&#39;</span><span class="p">)</span>

    <span class="c1"># Add the patch to the Axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Upper Colorado Annual Flow (Synthetic Stationary)&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Annual Flow (cubic feet per year)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_28_0.png" src="_images/hmm_28_0.png" />
<p>You can sample from the model and create more 105-year traces and note
how the location and number of decadal droughts changes. This
demonstrates how different the historical record can look just within
the range of natural variability. It’s also important to remember that
when droughts occur can also define the ultimate effect of the drought
(i.e. is it a time when there is a large population growth or a time
when humans can adapt by conserving or building more infrastructure?). A
hydrologic drought need not manifest into an agricultural or operational
drought of the same magnitude if stored surface water is available.</p>
<p>We externally run the HMM many times to create a dataset of 100
instances of the 105-year traces and 1000 instances of the 105-year
traces that are available in the package
(“synthetic_stationary_small_sample_100.csv”, “synthetic_stationary_large_sample_1000”).
The shaded green lines correspond to the flow duration curves (FDCs) for
the generated streamflow traces in comparison with the FDC of the
historical record in beige.</p>
<figure>
    <center><img src="_static/stationary_synthetic_FDC.png" style="width:75%"></center>
<figcaption style="text-align:center">Generated streamflow traces in comparison with the FDC of the historical record.</figcaption>
</figure><p>As expected, the stationary synthetic FDCs envelope the historical FDC
and particularly, the synthetic traces offer many more instances of low
flow conditions that could lead to more extreme drought conditions than
what has been observed historically. It is also useful to check for
convergence of samples and to determine how many samples are needed to
fully represent internal variability. Above we see that the extension to
1000 instances of 105-year traces fills out regions of the FDC,
including creating some more extreme drought conditions, but that
additional samples will likely not fill out the FDC substantially more.</p>
</section>
<section id="non-stationary-synthetic-generator-to-impose-climate-changes">
<h4><span class="section-number">B.6.2.3. </span>Non-Stationary Synthetic Generator to Impose Climate Changes<a class="headerlink" href="#non-stationary-synthetic-generator-to-impose-climate-changes" title="Link to this heading">#</a></h4>
<p>Now, we create flows under non-stationary conditions to get a better
understanding of what flows can look like under climate changes. In
order to create flows under non-stationary conditions, we can toggle the
parameters of the HMM model in order to create systematic changes to the
model that can represent a changing climate. The HMM has 6 parameters
that define it. When we fit the historical model, the parameters that
are fit represent a baseline parameter value. In this non-stationary
generator, we define a range to sample these parameters from.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Current Value</p></th>
<th class="head"><p>Lower Bound</p></th>
<th class="head"><p>Upper Bound</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Log-Space Wet State
Mean Multiplier</p></td>
<td><p>1.00</p></td>
<td><p>0.98</p></td>
<td><p>1.02</p></td>
</tr>
<tr class="row-odd"><td><p>Log-Space Dry State
Mean Multiplier</p></td>
<td><p>1.00</p></td>
<td><p>0.98</p></td>
<td><p>1.02</p></td>
</tr>
<tr class="row-even"><td><p>Log-Space Wet State
Standard Deviation
Multiplier</p></td>
<td><p>1.00</p></td>
<td><p>0.75</p></td>
<td><p>1.25</p></td>
</tr>
<tr class="row-odd"><td><p>Log-Space Dry State
Standard Deviation
Multiplier</p></td>
<td><p>1.00</p></td>
<td><p>0.75</p></td>
<td><p>1.25</p></td>
</tr>
<tr class="row-even"><td><p>Change in Dry-Dry
Transition
Probability</p></td>
<td><p>0.00</p></td>
<td><p>-0.30</p></td>
<td><p>+0.30</p></td>
</tr>
<tr class="row-odd"><td><p>Change in Wet-Wet
Transition
Probability</p></td>
<td><p>0.00</p></td>
<td><p>-0.30</p></td>
<td><p>+0.30</p></td>
</tr>
</tbody>
</table>
</div>
<p>Now let’s sample 1000 times from these bounds to create 1000 new
parameterizations of the model. Here we use SALib and the Latin
Hypercube sample function.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create problem structure with parameters that we want to sample</span>
<span class="n">problem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_vars&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;wet_mu&#39;</span><span class="p">,</span> <span class="s1">&#39;dry_mu&#39;</span><span class="p">,</span> <span class="s1">&#39;wet_std&#39;</span><span class="p">,</span><span class="s1">&#39;dry_std&#39;</span><span class="p">,</span><span class="s1">&#39;dry_tp&#39;</span><span class="p">,</span><span class="s2">&quot;wet_tp&quot;</span><span class="p">],</span>
    <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">1.25</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">1.25</span><span class="p">],</span>
               <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.3</span><span class="p">],</span>
               <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.3</span><span class="p">]]</span>
<span class="p">}</span>

<span class="c1"># generate 1000 parameterizations</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># set random seed for reproducibility</span>
<span class="n">seed_value</span> <span class="o">=</span> <span class="mi">123</span>

<span class="c1"># Generate our samples</span>
<span class="n">LHsamples</span> <span class="o">=</span> <span class="n">latin</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">seed_value</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s look at what some of the traces look like in our
non-stationary generator. Let’s choose a random instance from the
1000-member space and adjust the parameters accordingly.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define static parameters</span>
<span class="n">n_years</span> <span class="o">=</span> <span class="mi">105</span>

<span class="c1"># Sample parameter; Adjust to any sample number from 0-999</span>
<span class="n">sample</span> <span class="o">=</span> <span class="mi">215</span>

<span class="c1"># Create empty arrays to store the new Gaussian HMM parameters for each SOW</span>
<span class="n">Pnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">piNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
<span class="n">musNew_HMM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sigmasNew_HMM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
<span class="n">logAnnualQ_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_years</span><span class="p">])</span>

<span class="c1"># Calculate new transition matrix and stationary distribution of SOW at last node as well as new means and standard deviations</span>
<span class="n">Pnew</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="mi">4</span><span class="p">]))</span>
<span class="n">Pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="mi">5</span><span class="p">]))</span>
<span class="n">Pnew</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Pnew</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">Pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">eigenvals</span><span class="p">,</span> <span class="n">eigenvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pnew</span><span class="p">))</span>
<span class="n">one_eigval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">piNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pnew</span><span class="p">),</span> <span class="n">eigenvecs</span><span class="p">[:,</span> <span class="n">one_eigval</span><span class="p">]),</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pnew</span><span class="p">),</span> <span class="n">eigenvecs</span><span class="p">[:,</span><span class="n">one_eigval</span><span class="p">])))</span>

<span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
<span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># Generate first state and log-space annual flow at last node</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_years</span><span class="p">])</span>
<span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">piNew</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Generate remaining state trajectory and log space flows at last node</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_years</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">Pnew</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])]:</span>
        <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Convert log-space flows to real-space flows</span>
<span class="n">AnnualQ_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logAnnualQ_s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>Now let’s see what this synthetic trace looks like.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve samples and back-transform out of log space</span>
<span class="n">AnnualQ_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="p">)</span>
<span class="n">AnnualQ_s</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1909</span><span class="p">,</span> <span class="mi">2014</span><span class="p">))</span>

<span class="c1"># Define drought threshold</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>

<span class="c1"># Where does the rolling mean dip below the threshold</span>
<span class="n">drought_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span>
<span class="n">drought_years</span> <span class="o">=</span> <span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">drought_instances</span><span class="p">]</span>

<span class="c1"># Visualize the streamflow scenario</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the original line graph</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#005F73&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>

<span class="c1"># Plot a 11-year rolling mean</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#183A2E&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;11-Year Rolling Mean&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
           <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Drought Threshold&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">drought_years</span><span class="p">:</span>

    <span class="c1"># Plot a box centered around those values and with 5 years on either side.</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                             <span class="mi">11</span><span class="p">,</span>
                             <span class="mf">2e7</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#EFE2BE&#39;</span><span class="p">,</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#EFE2BE&#39;</span><span class="p">)</span>

    <span class="c1"># Add the patch to the Axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Annual Flow (Synthetic Non-Stationary)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Annual Flow (cubic feet per year)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_40_0.png" src="_images/hmm_40_0.png" />
<p>Above is the example trace from the new non-stationary model. You may
see fewer or more decadal drought instances. We can further summarize
overall decadal drought characteristics across the samples. Let’s plot a
histogram of the total number of times we go below the drought threshold
across these realizations.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decadal_drought_occurrence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">1000</span><span class="p">])</span>

<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>

    <span class="c1"># Create empty arrays to store the new Gaussian HMM parameters for each SOW</span>
    <span class="n">Pnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">piNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">musNew_HMM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">sigmasNew_HMM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">logAnnualQ_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_years</span><span class="p">])</span>

    <span class="c1"># Calculate new transition matrix and stationary distribution of SOW at last node</span>
    <span class="c1"># as well as new means and standard deviations</span>

    <span class="n">Pnew</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">Pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">5</span><span class="p">]))</span>
    <span class="n">Pnew</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Pnew</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">Pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">eigenvals</span><span class="p">,</span> <span class="n">eigenvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pnew</span><span class="p">))</span>
    <span class="n">one_eigval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">piNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pnew</span><span class="p">),</span> <span class="n">eigenvecs</span><span class="p">[:,</span> <span class="n">one_eigval</span><span class="p">]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Pnew</span><span class="p">),</span> <span class="n">eigenvecs</span><span class="p">[:,</span> <span class="n">one_eigval</span><span class="p">])))</span>

    <span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mus</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mus</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">LHsamples</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Generate first state and log-space annual flow at last node</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_years</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">piNew</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># generate remaining state trajectory and log space flows at last node</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_years</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">Pnew</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])]:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logAnnualQ_s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">musNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigmasNew_HMM</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Convert log-space flows to real-space flows</span>
    <span class="n">AnnualQ_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logAnnualQ_s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">AnnualQ_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="p">)</span>
    <span class="n">AnnualQ_s</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1909</span><span class="p">,</span> <span class="mi">2014</span><span class="p">))</span>

    <span class="c1"># Define drought threshold</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>

    <span class="c1"># Where does the rolling mean dip below the threshold</span>
    <span class="n">drought_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AnnualQ_s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span>
    <span class="n">decadal_drought_occurrence</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drought_instances</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">decadal_drought_occurrence</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Non-Stationary generator&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#005F73&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Instances of Decadal Drought&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_43_0.png" src="_images/hmm_43_0.png" />
<p>Note how many more instances of the decadal droughts we are creating
with the non-stationary generator than our observed 105-year trace which
creates a rich space in which we can test our models. Just as we did
with the stationary generator, we can externally run the non-stationary
generator to create 10,000 instances of the 105-year traces that are
available in the package
(“synthetic_nonstationary_large_sample_10000.csv”). The shaded green and
blue lines correspond to the FDCs for the stationary and non-stationary
generated streamflow traces in comparison with the FDC of the historical
record in beige. Note how the non-stationary generator produces even
more drought extremes than the stationary non-synthetic traces.</p>
<figure>
    <center><img src="_static/nonstationary_synthetic_FDC.png" style="width:75%"></center>
<figcaption style="text-align:center">Generated streamflow traces in comparison with the FDC of the historical record.</figcaption>
</figure></section>
<section id="placing-cmip5-projections-in-the-context-of-non-stationary-flows">
<h4><span class="section-number">B.6.2.4. </span>Placing CMIP5 Projections in the Context of Non-Stationary Flows<a class="headerlink" href="#placing-cmip5-projections-in-the-context-of-non-stationary-flows" title="Link to this heading">#</a></h4>
<p>We have broadened the drought conditions that we are creating which that
can be very useful to understand how our water systems model performs
under potentially extreme scenarios. However, it’s useful to compare our
bottom-up synthetically generated flows in the context of global
physically-driven CMIP5 projections to get a better understanding of how
the two approaches compare. We first aquire 97 CMIP5 projections from
the Colorado River Water Availability Study (CWCB, 2012). In each of
these projections, monthly precipitation factor changes and temperature
delta changes were computed between mean projected 2035–2065 climate
statistics and mean historical climate statistics from 1950–2013. These
97 different combinations of 12 monthly precipitation multipliers and 12
monthly temperature delta shifts were applied to historical
precipitation and temperature time series from 1950–2013. The resulting
climate time series were run through a Variable Infiltration Capacity
(VIC) model of the UCRB, resulting in 97 time series of projected future
streamflows at the Colorado‐Utah state line.</p>
<p>We fit an HMM to each trace of projected streamflow and get a set of
corresponding HMM parameters. Then we take the ratio between these
parameters and the baseline HMM parameters that we calculated earlier in
the notebook in order to calculate the multipliers associated with each
CMIP5 projection. This is all done externally, so we import the
resulting multipliers in the next line.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in CMIP5 and paleo multipliers</span>
<span class="n">CMIP5_multipliers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/CMIP5_SOWs.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s plot a response surface that will allow us to see how combinations
of HMM parameters tend to influence decadal drought. In order to get a
continuous surface, we’ll fit a non-linear regression to the parameter
values and then predict the decadal drought over a set of grid points.
We fit the response surface for two parameters that should have an
affect on decadal drought: the dry distribution mean and the dry-dry
transition probabilites.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose two parameters to fit the response surface for</span>
<span class="n">mu_dry</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">LHsamples</span><span class="p">]</span>
<span class="n">tp_dry</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">LHsamples</span><span class="p">]</span>

<span class="c1"># Create an interpolation grid</span>
<span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mu_dry</span><span class="p">),</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mu_dry</span><span class="p">),</span>
                  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mu_dry</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mu_dry</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tp_dry</span><span class="p">),</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tp_dry</span><span class="p">),</span>
                  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tp_dry</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tp_dry</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Fit regression</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Dry_Tp&#39;</span><span class="p">:</span> <span class="n">tp_dry</span><span class="p">,</span>
     <span class="s1">&#39;Dry_Mu&#39;</span><span class="p">:</span> <span class="n">mu_dry</span><span class="p">,</span>
     <span class="s1">&#39;Drought_Occurrence&#39;</span><span class="p">:</span><span class="n">decadal_drought_occurrence</span><span class="p">}</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">df</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dry_Tp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dry_Mu&#39;</span><span class="p">]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Dry_Mu&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Dry_Tp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Interaction&#39;</span><span class="p">]</span>
<span class="n">ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Drought_Occurrence&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ols</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Calculate drought occurrence for each grid point</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">])</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
<span class="n">z</span><span class="p">[</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># replace negative shortage predictions with 0</span>
</pre></div>
</div>
<p>Let’s plot our results:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set color gradient for response surface</span>
<span class="n">drought_map</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Reshape our predicted drought occurrence and define bounds of colors</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Drought_Occurrence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)])</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="c1"># Plot response surface and CMIP5 projections</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">drought_map</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">CMIP5_multipliers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">7</span><span class="p">],</span>
           <span class="n">CMIP5_multipliers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">12</span><span class="p">],</span>
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#ffffb3&#39;</span><span class="p">,</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">drought_map</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dry State Mu&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dry-Dry Transition Probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Decadal Drought Occurrence&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/hmm_53_0.png" src="_images/hmm_53_0.png" />
<p>We see the influence of the dry state mean and dry-dry transition
parameters. We’re likely to see more decadal droughts when we (1)
increase the dry-dry transition probability, which inherently will
increase persistence of the dry state, and (2) when we make the dry
state log mean drier. Note that the CMIP5 scenarios tend to span the
extent of the dry mean sample space, but are less representative of the
dry transition probability sample space, which suggests that the types
of hydrological droughts represented in the projections tend to only be
wetter to slightly drier than our baseline. Both methods of producing
these scenarios are valid, though studies have suggested that
globally-resolved GCMs may be inappropriate to represent regional
extremes. Ultimately, if your goal is to produce a variety of ensembles
that are characterized by many different drought characteristics, you
will likely find that a generator approach will serve this purpose
better.</p>
</section>
<section id="tips-to-create-an-hmm-based-generator-for-your-system">
<h4><span class="section-number">B.6.2.5. </span>Tips to Create an HMM-Based Generator for your System<a class="headerlink" href="#tips-to-create-an-hmm-based-generator-for-your-system" title="Link to this heading">#</a></h4>
<p>In this tutorial, we demonstrated how to fit an HMM-based generator for
a single gauge located in the Upper Colorado River Basin. In order to
apply this methodology to your problem, you will need to first ask:</p>
<ol class="arabic simple">
<li><p>Is this model appropriate for my location of interest? We have
applied this style of generator to locations where persistent wet
and dry states are characteristic, which tends to be in the Western
US. Ultimately the best way to judge if an HMM is useful for your
application is to fit the model and explore the resulting
distributions. Are there two (or more) distinct states that emerge?
If not, then your location may not exhibit the type of persistence
that an HMM-based generator is useful for. You can consider
exploring other styles of generators such as the Kirsch-Nowak
generator (Kirsch et al., 2013).</p></li>
<li><p>Do I have the right datasets? We use annual data for our location of
interest. In this notebook, the HMM is fit to log annual flows.
Ultimately, it can be disaggregated to daily flows (using a
reference historical daily dataset) to be useful in water resources
operational applications. You could also disaggregate to a finer
resolution than daily if the historical dataset exists.</p></li>
</ol>
<p>If you meet these requirements, feel free to proceed through fitting the
model using the code available in the notebook. Be sure to consider the
appropirate number of samples to generate (both in a stationary and
non-stationary case). Make sure that you test multiple sample sizes and
continue to increase your sample size until you converge to a consistent
representation of extremes. What is the appropriate number of LHS
samples of the parameters to use? In this experiment we used 1,000
samples of parameters due to extensive stability tests described in
Quinn et al. (2020).</p>
<p>Finally, to learn more about this test case refer to Hadmichael et
al. (2020a) and Hadmichael et al. (2020b). For another study on
synthetic drought generation to support vulnerability assessments in the
Research Triangle region of North Carolina, please refer to Herman et
al. (2016)</p>
</section>
<section id="id32">
<h4><span class="section-number">B.6.2.6. </span>References<a class="headerlink" href="#id32" title="Link to this heading">#</a></h4>
<p>Ault, T. R., Cole, J. E., Overpeck, J. T., Pederson, G. T., &amp; Meko, D.
M. (2014). Assessing the risk of persistent drought using climate model
simulations and paleoclimate data. Journal of Climate, 27(20),
7529-7549.</p>
<p>CWCB (2012).Colorado River Water Availability Study Phase I Report.
Colorado Water Conservation Board</p>
<p>Hadjimichael, A., Quinn, J., Wilson, E., Reed, P., Basdekas, L., Yates,
D., &amp; Garrison, M. (2020a). Defining robustness, vulnerabilities, and
consequential scenarios for diverse stakeholder interests in
institutionally complex river basins. Earth’s Future, 8(7),
e2020EF001503.</p>
<p>Hadjimichael, A., Quinn, J., &amp; Reed, P. (2020). Advancing diagnostic
model evaluation to better understand water shortage mechanisms in
institutionally complex river basins. Water Resources Research, 56(10),
e2020WR028079.</p>
<p>Herman, J. D., Zeff, H. B., Lamontagne, J. R., Reed, P. M., &amp;
Characklis, G. W. (2016). Synthetic drought scenario generation to
support bottom-up water supply vulnerability assessments. Journal of
Water Resources Planning and Management, (11), 04016050.</p>
<p>Kirsch, B. R., Characklis, G. W., &amp; Zeff, H. B. (2013). Evaluating the
impact of alternative hydro-climate scenarios on transfer agreements:
Practical improvement for generating synthetic streamflows. Journal of
Water Resources Planning and Management, 139(4), 396-406.</p>
<p>Overpeck, J.T. &amp; Udall, B. (2020) “Climate change and the aridification
of North America.” Proceedings of the national academy of sciences
117.22 11856-11858.</p>
<p>Quinn, J. D., Hadjimichael, A., Reed,P. M., &amp; Steinschneider, S. (2020).
Canexploratory modeling of water scarcity vulnerabilities and robustness
bescenario neutral?Earth’s Future,8,e2020EF001650.
<a class="reference external" href="https://doi.org/10.1029/2020EF001650Received">https://doi.org/10.1029/2020EF001650Received</a></p>
<p>Williams, A. P., Cook, B. I., &amp; Smerdon, J. E. (2022). Rapid
intensification of the emerging southwestern North American megadrought
in 2020–2021. Nature Climate Change, 12(3), 232-234.</p>
</section>
</section>
</section>
<section id="model-calibration-with-markov-chain-monte-carlo-tutorial">
<h2><span class="section-number">B.7. </span>Model Calibration with Markov chain Monte Carlo Tutorial<a class="headerlink" href="#model-calibration-with-markov-chain-monte-carlo-tutorial" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Run the tutorial interactively:  <a class="reference external" href="https://uc-ebook.msdlive.org/user-redirect/lab/tree/notebooks/mcmc.ipynb">MCMC Notebook</a>.</div>
<div class="line">Please be aware that notebooks can take a couple minutes to launch.</div>
<div class="line">To run the notebooks yourself, download the files <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/tree/main/notebooks">here</a> and use these <a class="reference external" href="https://github.com/IMMM-SFA/msd_uncertainty_ebook/blob/main/pyproject.toml">requirements</a>.</div>
</div>
</div>
<div class="admonition-community-contribution admonition">
<p class="admonition-title">Community Contribution</p>
<div class="line-block">
<div class="line">This tutorial was contributed by the community. Use the citation below in additional to the main citation when referencing this code:</div>
<div class="line"><br /></div>
<div class="line"><em>Srikrishnan, V. (2025). Model Calibration with Markov Chain Monte Carlo Tutorial (v1.0.0). MSD-LIVE Data Repository. https://doi.org/10.57931/2565322</em></div>
</div>
</div>
<section id="model-calibration-with-markov-chain-monte-carlo">
<h3><span class="section-number">B.7.1. </span>Model Calibration with Markov chain Monte Carlo<a class="headerlink" href="#model-calibration-with-markov-chain-monte-carlo" title="Link to this heading">#</a></h3>
<p>The purpose of this tutorial is to demonstrate how to use Markov chain
Monte Carlo (MCMC) to calibrate a model. By calibration, we mean the
selection of model parameters (and, when relevant, structures). This
tutorial notebook will build on the <a class="reference internal" href="#hymod-dynamics-tutorial"><span class="std std-ref">HYMOD sensitivity analysis notebook</span></a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">msdbook</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">msdbook.hymod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">msdbook.package_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_hymod_input_file</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set seed for reproducibility</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from msdbook.install_supplement import install_package_data</span>
<span class="c1"># install_package_data()</span>
</pre></div>
</div>
<section id="mcmc-for-model-calibration-and-uncertainty-quantification">
<h4><span class="section-number">B.7.1.1. </span>MCMC for Model Calibration and Uncertainty Quantification<a class="headerlink" href="#mcmc-for-model-calibration-and-uncertainty-quantification" title="Link to this heading">#</a></h4>
<section id="bayesian-uncertainty-quantification">
<h5>Bayesian Uncertainty Quantification<a class="headerlink" href="#bayesian-uncertainty-quantification" title="Link to this heading">#</a></h5>
<p>A common goal in model development and diagnostics is <em>calibration</em>, or
the identification of model structures and parameters which are
consistent with data. While models can be calibrated through hand-tuning
parameters or minimizing simple error metrics such as
root-mean-square-error (RMSE), these approaches can underrepresent the
probabilistic nature of the data-generating process, as well as the
potential for multiple model configurations to be consistent with the
data. Probabilistic uncertainty quantification, which is the topic of
this notebook, can address these concerns.</p>
<p>The notion that different model configurations can be consistent with
data to different degrees is related to the Bayesian interpretation of
probability as representing the degree of belief in an outcome. Bayesian
uncertainty quantification has two characteristics:</p>
<ol class="arabic">
<li><p>Obtaining probability distributions over model structures and/or
parameter values <span class="math notranslate nohighlight">\(\theta\)</span> reflecting consistency with prior
beliefs <span class="math notranslate nohighlight">\(p(\theta)\)</span> and data <span class="math notranslate nohighlight">\(y\)</span>. These probabilities
represent the <em>posterior</em> probability emerging from Bayes’ Rule,</p>
<div class="math notranslate nohighlight">
\[p(\theta | y) \propto p(y |\theta) p(\theta),\]</div>
<p>where <span class="math notranslate nohighlight">\(p(y | \theta)\)</span> is the <em>likelihood</em> of seeing the data
given the parameterization <span class="math notranslate nohighlight">\(\theta\)</span>. The likelihood captures
the probability model by which the data is observed and can include
bias terms, observation errors, or other influences.</p>
</li>
<li><p>The use of prior distributions. Priors are classically thought of as
means to express beliefs about admissible or plausible values, but
they can also be used to limit the degree of overfitting by requiring
more data to force more extreme parameter estimates.</p></li>
</ol>
<p>The fundamental challenge is that of sampling from the posterior
probability distribution, which may not have a nice representation. MCMC
is one family of approaches to solving that challenge.</p>
</section>
<section id="rejection-sampling">
<h5>Rejection Sampling<a class="headerlink" href="#rejection-sampling" title="Link to this heading">#</a></h5>
<p>Many methods for drawing samples (or simulating) from “non-standard”
distributions rely on an accept-reject approach, where samples are
generated from an easier-to-simulate <em>proposal</em> distribution and are
probabilistically accepted or rejected based on the relative probability
density between the proposal and the target distribution.</p>
<p>To illustrate this accept-reject concept, we can use an algorithm called
<em>rejection sampling</em>. Rejection sampling involves simulation of
independent and identically-distributed (i.i.d.) samples from a proposal
distribution which “covers” the target distribution. More specifically,
let <span class="math notranslate nohighlight">\(\pi(x)\)</span> be the (known) density of the target distribution,
and let <span class="math notranslate nohighlight">\(g(x)\)</span> be a density which satisfies
<span class="math notranslate nohighlight">\(\pi(x) &lt; M g(x)\)</span> where <span class="math notranslate nohighlight">\(1 &lt; M &lt; \infty\)</span>; in other words.
This covering property is essential to ensure that values are proposed
across the entire range of <span class="math notranslate nohighlight">\(\pi\)</span> with positive probability (called
the <em>support</em>). We can see an example of this in the figure below.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the target mixture model pdf.</span>
<span class="c1"># This represents a 50/50 mixture of N(-1, 0.75) and N(1, 0.4).</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mixture_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="c1"># Create an array of x values from -5 to 5 with a step of 0.01.</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># Set the number of samples and the constant M for rejection sampling.</span>
<span class="n">nsamp</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">M</span> <span class="o">=</span> <span class="mf">2.5</span>

<span class="c1"># Draw nsamp samples from the proposal distribution (Normal(0, 1.5)).</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsamp</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">nsamp</span><span class="p">)</span>

<span class="c1"># Calculate the proposal density g and target density f at y.</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">mixture_pdf</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Acceptance criterion: u &lt; f / (M * g)</span>
<span class="n">keep_samp</span> <span class="o">=</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">g</span><span class="p">))</span>
<span class="n">accepted</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">keep_samp</span><span class="p">]</span>

<span class="c1"># Estimate density using Gaussian KDE.</span>
<span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span>
<span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">accepted</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">accepted</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">200</span><span class="p">)</span>

<span class="c1"># Plot the target mixture model and the proposal distribution.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mixture_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Proposal (M=2.5)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">accepted</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kept Samples&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mixture_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Target&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">kde</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sampled Density&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_9_0.png" src="_images/mcmc_9_0.png" />
</figure>
<p>The rejection sampling algorithm is then:</p>
<ol class="arabic simple">
<li><p>Simulate <span class="math notranslate nohighlight">\(Y_i \sim g(x)\)</span>;</p></li>
<li><p>Simulate <span class="math notranslate nohighlight">\(U_i \sim \text{Uniform}(0, 1)\)</span>.</p></li>
<li><p>Accept <span class="math notranslate nohighlight">\(Y_i\)</span> if <span class="math notranslate nohighlight">\(U_i &lt;= \pi(Y_i) / Mg(Y_i)\)</span>.</p></li>
</ol>
<p>In other words, <span class="math notranslate nohighlight">\(Y\)</span> is accepted as a sample from <span class="math notranslate nohighlight">\(\pi(x)\)</span>
with probability <span class="math notranslate nohighlight">\(\rho = \pi(x) / Mg(x)\)</span>. As a result of this
procedure, the proposals <span class="math notranslate nohighlight">\((Y_i, U_i)\)</span> are uniformly distributed
over the area under the curve of <span class="math notranslate nohighlight">\(g(x)\)</span>, and the rejection
procedure results in the accepted samples being uniformly distributed
over the area under the curve of <span class="math notranslate nohighlight">\(\pi(x)\)</span>, as desired.</p>
<p>An illustration of rejection sampling can be seen below.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set parameters</span>
<span class="n">nsamp</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">M</span> <span class="o">=</span> <span class="mf">3.5</span>

<span class="c1"># Generate nsamp samples from Uniform(0, 1) for u and y</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsamp</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsamp</span><span class="p">)</span>

<span class="c1"># Compute the Beta(5, 10) pdf at each y value</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Determine which samples to keep: condition (M * u) &lt; f</span>
<span class="n">keep_samp</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">f</span>

<span class="c1"># Create the figure with the desired size.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Rejection Sampling Efficiency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># First plot</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$X$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># Plot the Beta(5, 10) density line</span>
<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Beta(5,10)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">keep_samp</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="c1"># Second plot</span>
<span class="n">accepted</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">keep_samp</span><span class="p">]</span>
<span class="c1"># Create a density estimate using Gaussian KDE.</span>
<span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span>

<span class="c1"># Define x values for the density plot.</span>
<span class="n">x1_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">density_vals</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">x1_vals</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1_vals</span><span class="p">,</span> <span class="n">density_vals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$X$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Sample Density Estimate&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_11_0.png" src="_images/mcmc_11_0.png" />
</figure>
<p>There are several downsides and practical challenges associated with
rejection sampling, which helps motivate the use of Markov chain Monte
Carlo methods, such as the Metropolis-Hastings algorithm. In particular,
the expected value of the acceptance rate is approximately <span class="math notranslate nohighlight">\(1/M\)</span>,
which means choosing a proposal density that minimizes <span class="math notranslate nohighlight">\(M\)</span> while
still covering <span class="math notranslate nohighlight">\(\pi\)</span> is valuable. However, this can be challenging
for complex target distributions or, in particular, high-dimensional
distributions.</p>
</section>
<section id="markov-chain-monte-carlo">
<h5>Markov chain Monte Carlo<a class="headerlink" href="#markov-chain-monte-carlo" title="Link to this heading">#</a></h5>
<p>Markov chain Monte Carlo (MCMC) is a family of algorithms to sample from
(almost) arbitrary probability distributions. The underlying idea is to
construct a Markov chain of samples whose stationary distribution is the
same as the target distribution <span class="math notranslate nohighlight">\(\pi\)</span>. That the target
distribution is the <em>stationary</em> distribution of the constructed chain
is important for <a class="reference internal" href="#tips-for-using-mcmc"><span class="std std-ref">diagnostics</span></a>.</p>
<p>While there are many MCMC algorithms, the most fundamental is the
<strong>Metropolis-Hastings algorithm</strong>. We will focus on the
Metropolis-Hastings algorithm in this tutorial, as it makes the MCMC
procedure and the impacts of choices transparent, though <a class="reference internal" href="#challenges-and-next-steps"><span class="std std-ref">other
approaches</span></a> can scale better.</p>
<p>The Metropolis-Hastings algorithm relies on an accept-reject step to
ensure that the resulting Markov transition probabilities have the right
properties to ensure convergence to the target distribution <span class="math notranslate nohighlight">\(\pi\)</span>.
This requires the specification of a <em>proposal distribution</em> <span class="math notranslate nohighlight">\(q\)</span>.</p>
<p>0. Start from an initial parameter value</p>
<div class="math notranslate nohighlight">
\[x_0.\]</div>
<p>Given</p>
<div class="math notranslate nohighlight">
\[X_t = x_t:\]</div>
<p>1. Generate</p>
<div class="math notranslate nohighlight">
\[Y_t \sim q(y | x_t);\]</div>
<p>2. Set</p>
<div class="math notranslate nohighlight">
\[X_{t+1} = Y_t\]</div>
<p>with probability</p>
<div class="math notranslate nohighlight">
\[\rho(x_t, Y_t)\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\rho(x, y) = \min \left\{\frac{\pi(y)}{\pi(x)}\frac{q(x | y)}{q(y | x)}, 1\right\},\]</div>
<p>else set</p>
<div class="math notranslate nohighlight">
\[X_{t+1} = x_t.\]</div>
<p>Often the proposal distribution is chosen to be symmetric,
<span class="math notranslate nohighlight">\(q(y | x) = q(x | y)\)</span>, so the accept-reject probability
<span class="math notranslate nohighlight">\(\rho(x, y) = \min\{\pi(y)/\pi(x), 1\}\)</span>. We will look later at the
impact of choices of <span class="math notranslate nohighlight">\(q\)</span> and some adaptive approaches.</p>
<p>We can visualize how the algorithm works in practice with the figure
below. The impact of the accept-reject step is that proposals which
increase the target probability relative to the current value
<span class="math notranslate nohighlight">\((\pi(Y_t) &gt; \pi(X_t)\)</span>, as in the top panel) will always be
accepted, while proposals which decrease the target probability (as in
the bottom panel) will be accepted based on the ratio of
<span class="math notranslate nohighlight">\(\pi(Y_t) / \pi(X_t)\)</span>. In this case, the probability of accepting
the proposal of <span class="math notranslate nohighlight">\(y\)</span> is approximately 0.3. If the proposal is
accepted, <span class="math notranslate nohighlight">\(X_{t+1} = Y_t\)</span> and the new proposal is centered on
<span class="math notranslate nohighlight">\(Y_t\)</span>, while if it is rejected, <span class="math notranslate nohighlight">\(X_{t+1} = x_t\)</span> and the
value is repeated in the resulting Markov chain.</p>
<figure class="align-default" id="id37">
<img alt="_images/mh-1.png" src="_images/mh-1.png" />
<figcaption>
<p><span class="caption-number">Fig. B.3 </span><span class="caption-text">Metropolis-Hastings step where the proposal is always accepted as it has higher probability according to the target density <span class="math notranslate nohighlight">\(\pi\)</span> than the current value</span><a class="headerlink" href="#id37" title="Link to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id38">
<img alt="_images/mh-2.png" src="_images/mh-2.png" />
<figcaption>
<p><span class="caption-number">Fig. B.4 </span><span class="caption-text">Metropolis-Hastings step where the proposal may not be accepted as it has lower probability according to the target density <span class="math notranslate nohighlight">\(\pi\)</span> than the current value. In this case, <span class="math notranslate nohighlight">\(\pi(y) / \pi(x) \approx 0.30\)</span>, so the proposal will be accepted with probability 30%.</span><a class="headerlink" href="#id38" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The sequential accept-reject step and the localization of the proposal
density on the current sample <span class="math notranslate nohighlight">\(X_t\)</span> is what results in the
autocorrelation of the Markov chain, which has implications for the use
of the resulting samples for Monte Carlo estimation and simulation.
Namely, the <em>effective sample size</em></p>
<div class="math notranslate nohighlight">
\[N_\text{eff} = \frac{N}{1 + 2 \sum_{i=1}^\infty \rho_i},\]</div>
<p>is always less than <span class="math notranslate nohighlight">\(N\)</span>, and can be dramatically smaller if the
resulting chain has very high autocorrelation. <span class="math notranslate nohighlight">\(N_\text{eff}\)</span> is
the value that should be used to estimate the Monte Carlo standard error
for any resulting estimatation.</p>
<p>However, this autocorrelation across the samples is a potentially small
price to pay for the flexibility of MCMC. The local proposals mean that
there is no need to find a “general” covering distribution, as in
rejection sampling, which allows the Metropolis-Hastings algorithm to be
practical in higher dimensions and for distributions with unexpected
features such as multi-modality.</p>
<p>In code form, the Metropolis-Hastings algorithm looks like this.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inputs:</span>
<span class="c1">#   - num_iter: Int, number of iterations to run Metropolis_Hastings algorithm</span>
<span class="c1">#   - proposal_sd: List or vector of proposal standard deviations, corresponding to each parameter</span>
<span class="c1">#   - p0: initial parameter vector</span>
<span class="c1">#   - logposterior: function to calculate the log-posterior for a given parameter vector</span>
<span class="c1"># Outputs:</span>
<span class="c1">#   - parameters: matrix of sampled parameters, num_iter x num_parameters</span>
<span class="c1">#   - lp: vector of log-posterior values for the sampled parameters</span>
<span class="c1">#   - accept_rate: Float of the percentage of proposals which were accepted.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">metropolis</span><span class="p">(</span><span class="n">num_iter</span><span class="p">,</span> <span class="n">proposal_sd</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">logposterior</span><span class="p">):</span>
    <span class="c1"># Initialize our lists for sampled parameters and log-posterior values</span>
    <span class="c1"># Create empty array</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">p0</span><span class="p">)))</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Set initial values</span>
    <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">p0</span>
    <span class="n">lp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">logposterior</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
    <span class="c1"># Set up proposal covariance matrix</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">Covariance</span><span class="o">.</span><span class="n">from_diagonal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">proposal_sd</span><span class="p">))</span>
    <span class="n">acceptances</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Propose a new state</span>
        <span class="n">proposal</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span>
        <span class="c1"># Calculate the acceptance probability</span>
        <span class="n">lp_proposal</span> <span class="o">=</span> <span class="n">logposterior</span><span class="p">(</span><span class="n">proposal</span><span class="p">)</span>
        <span class="n">p_accept</span> <span class="o">=</span> <span class="n">lp_proposal</span> <span class="o">-</span> <span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">p_accept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p_accept</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">uniform</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
        <span class="c1"># Accept with probability p_accept</span>
        <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p_accept</span><span class="p">):</span>
            <span class="c1"># Add the proposed parameter to the end of the list `parameters`</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">proposal</span>
            <span class="c1"># Add the corresponding posterior score to the end of that list too</span>
            <span class="n">acceptances</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp_proposal</span>
        <span class="c1"># Reject with probability 1-p_accept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add another copy of the current parameter value to the end of the list `parameters`</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># Add the corresponding posterior score to the end of that list too</span>
            <span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Calculate the acceptance rate; this is a useful diagnostic</span>
    <span class="n">accept_rate</span> <span class="o">=</span> <span class="n">acceptances</span> <span class="o">/</span> <span class="n">num_iter</span>
    <span class="c1"># Leave off the initial value but return the rest</span>
    <span class="k">return</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">lp</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">accept_rate</span>
</pre></div>
</div>
</section>
</section>
<section id="hymod-calibration">
<h4><span class="section-number">B.7.1.2. </span>HYMOD Calibration<a class="headerlink" href="#hymod-calibration" title="Link to this heading">#</a></h4>
<p>Let’s look at how well HYMOD with some default parameters explain the
streamflow data. This example may take a while to converge; HYMOD is
sufficiently complex (both computationally and in terms of dynamics)
that this “naive” approach to MCMC is relatively slow on a local
machine. We will discuss some alternative approaches for this category
of models in Section 3 (Diagnostics).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the Leaf River HYMOD input file</span>
<span class="n">leaf_data</span> <span class="o">=</span> <span class="n">load_hymod_input_file</span><span class="p">()</span>

<span class="c1"># extract the first eleven years of data</span>
<span class="n">leaf_data</span> <span class="o">=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4015</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Leaf River Data structure:&#39;</span><span class="p">)</span>

<span class="c1"># There are only three columns in the file including precipitation, potential evapotranspiration, and streamflow</span>
<span class="n">leaf_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Leaf</span> <span class="n">River</span> <span class="n">Data</span> <span class="n">structure</span><span class="p">:</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Precip</th>
      <th>Pot_ET</th>
      <th>Strmflw</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>4.60</td>
      <td>0.29</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>4.31</td>
      <td>0.24</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>4.33</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>4.78</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>2.91</td>
      <td>0.18</td>
    </tr>
  </tbody>
</table>
</div><p>Let’s look at how well the model performs with some default parameter
values.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># assign input parameters to generate a baseline simulated streamflow</span>
<span class="n">Nq</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of quickflow routing tanks</span>
<span class="n">Kq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Quickflow routing tanks&#39; rate parameter</span>
<span class="n">Ks</span> <span class="o">=</span>  <span class="mf">0.001</span> <span class="c1"># Slowflow routing tank&#39;s rate parameter</span>
<span class="n">Alp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Quick/slow split parameter</span>
<span class="n">Huz</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Maximum height of soil moisture accounting tank</span>
<span class="n">B</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># Scaled distribution function shape parameter</span>

<span class="c1"># Note that the number of years is 11. One year of model warm-up and ten years are used for actual simulation</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">hymod</span><span class="p">(</span><span class="n">Nq</span><span class="p">,</span> <span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="o">=</span><span class="mi">4015</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">plot_observed_vs_simulated_streamflow</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">leaf_data</span><span class="p">,</span> <span class="n">hymod_dict</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_22_0.png" src="_images/mcmc_22_0.png" />
</figure>
<p>We can see that this HYMOD parameterization generally does well, but
tends to underestimate the peak streamflows. Can we do better?</p>
<p>First, we need to specify a probability model for the data. To do this,
we can write the data <span class="math notranslate nohighlight">\(y_t\)</span> as the sum of the model output
<span class="math notranslate nohighlight">\(F(\theta_F; \mathbf{x}_t)\)</span> (where <span class="math notranslate nohighlight">\(\theta_F\)</span> is the
parameter vector and <span class="math notranslate nohighlight">\(\mathbf{x}_t\)</span> are the exogenous model
forcings) and the residuals <span class="math notranslate nohighlight">\(\mathbf{z}_t(\theta_z)\)</span>, where
<span class="math notranslate nohighlight">\(\theta_z\)</span> are the statistical parameters used to describe the
residual distribution. The residual probability model can be relatively
simple, such as the common assumption that <span class="math notranslate nohighlight">\(\mathbf{z}_t\)</span> are
independently distributed according to a Gaussian distribution, or can
be more complex, including auto-correlations, cross-correlations, and/or
combinations of systematic <em>model data-discrepancy</em> and independent
observation errors.</p>
<p>In this example, we will assume that the residuals are normally
distributed (on the log scale, since HYMOD predictions and streamflow
are non-negative), though in practice we would check this assumption by
fitting the model and looking at residual diagnostics, such as partial
autocorrelation and Q-Q plots. Since HYMOD can simulate zero streamflow,
which is not in the data, we will also include a strictly positive bias
term <span class="math notranslate nohighlight">\(\beta\)</span>. As a result, our probability model is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{gather*}
\log(y_t) = \log(F(\theta_F; \mathbf{x}_t) + \beta) + z_t \\
z_t \sim \mathcal{N}(0, \sigma)
\end{gather*}\end{split}\]</div>
<p>This means that we need the following model and statistical parameters:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Nq</span></code>: the number of quickflow routing tanks;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Kq</span></code>: the quickflow routing tanks’ rate parameter;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ks</span></code>: The slowflow routing tanks’ rate parameter;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Alp</span></code>: The quick/slow split parameter;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Huz</span></code>: The maximum height of soil moisture accounting tank;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code>: The scaled distribution function scale parameter;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">beta</span></code>: Positive bias term, since HYMOD can produce zero simulated
streamflow;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma</span></code>: Standard deviation of the log-residual normal
distribution.</p></li>
</ol>
<section id="prior-distributions">
<h5>Prior Distributions<a class="headerlink" href="#prior-distributions" title="Link to this heading">#</a></h5>
<p>MCMC lets us sample from arbitrary probability distributions, including
Bayesian posterior distributions. One advantage of a Bayesian approach
to model calibration is that it lets us include prior information for
parameter values, which can help guide inferences towards
mechanistically reasonable values. In the absence of firm prior
information about parameter values, we can check that prior
distributions result in reasonable simulations with a <em>prior predictive
check</em>. Let’s start with the following priors, which we assume are
independent across parameter.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Kq</span></code>: <span class="math notranslate nohighlight">\(\text{LogNormal}(0.25, 0.5)\)</span>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ks</span></code>: <span class="math notranslate nohighlight">\(\text{LogNormal}(0.95, 0.003)\)</span>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Alp</span></code>: <span class="math notranslate nohighlight">\(\text{Beta}(2, 2)\)</span>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Huz</span></code>: <span class="math notranslate nohighlight">\(\mathcal{N}(100, 20)\)</span>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code>: <span class="math notranslate nohighlight">\(\text{LogNormal}(0.1, 1)\)</span>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">beta</span></code>: <span class="math notranslate nohighlight">\(\text{LogNormal}(0.05, 0.5)\)</span>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma</span></code>: <span class="math notranslate nohighlight">\(\text{LogNormal}(0.5, 0.5)\)</span>.</p></li>
</ol>
<p>To conduct a prior predictive check, we will generate samples from these
distributions, evaluate the model (and add residuals), and then look at
the distribution of output (or output summary statistics) about which we
have some intuition about what are reasonable values. Note that we will
not explicitly compare these results to the data, we do not want to
overfit.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">array</span><span class="p">([</span> <span class="mf">13.</span><span class="p">,</span>  <span class="mf">59.</span><span class="p">,</span> <span class="mf">139.</span><span class="p">,</span> <span class="mf">255.</span><span class="p">,</span> <span class="mf">264.</span><span class="p">,</span> <span class="mf">159.</span><span class="p">,</span>  <span class="mf">85.</span><span class="p">,</span>  <span class="mf">21.</span><span class="p">,</span>   <span class="mf">4.</span><span class="p">,</span>   <span class="mf">1.</span><span class="p">]),</span>
 <span class="n">array</span><span class="p">([</span><span class="mf">0.43029764</span><span class="p">,</span> <span class="mf">0.44725484</span><span class="p">,</span> <span class="mf">0.46421203</span><span class="p">,</span> <span class="mf">0.48116923</span><span class="p">,</span> <span class="mf">0.49812642</span><span class="p">,</span>
        <span class="mf">0.51508362</span><span class="p">,</span> <span class="mf">0.53204081</span><span class="p">,</span> <span class="mf">0.54899801</span><span class="p">,</span> <span class="mf">0.5659552</span> <span class="p">,</span> <span class="mf">0.5829124</span> <span class="p">,</span>
        <span class="mf">0.59986959</span><span class="p">]),</span>
 <span class="o">&lt;</span><span class="n">BarContainer</span> <span class="nb">object</span> <span class="n">of</span> <span class="mi">10</span> <span class="n">artists</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_25_1.png" src="_images/mcmc_25_1.png" />
</figure>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndays</span> <span class="o">=</span> <span class="mi">4015</span>
<span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># generate prior samples</span>
<span class="n">Kq_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">Ks_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.003</span><span class="p">)</span>
<span class="n">Alp_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Huz_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">B_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">beta_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">sigma_prior</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">Kq</span> <span class="o">=</span> <span class="n">Kq_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">Ks</span> <span class="o">=</span> <span class="n">Ks_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">Alp</span> <span class="o">=</span> <span class="n">Alp_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">Huz</span> <span class="o">=</span> <span class="n">Huz_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">B_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">beta_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_prior</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>

<span class="c1"># preallocate output storage</span>
<span class="n">prior_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndays</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">))</span>

<span class="c1"># note that we include the error/noise in these simulations</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsamples</span><span class="p">):</span>
    <span class="n">prior_out</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">hymod</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Kq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Ks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Alp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Huz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="o">=</span><span class="n">ndays</span><span class="p">)[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">ndays</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute 90% prediction interval for each time step</span>
<span class="n">prior_q90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">prior_out</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">strmflw_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">),</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">Strmflw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">),</span> <span class="n">prior_q90</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">),</span> <span class="n">prior_q90</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">prior_q90</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Observations&#39;</span><span class="p">,</span> <span class="s1">&#39;Prior Predictive Median&#39;</span><span class="p">,</span> <span class="s1">&#39;90% Prior Predictive Interval&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_27_1.png" src="_images/mcmc_27_1.png" />
</figure>
<p>This looks reasonable as a starting point; we may not be capturing the
most extreme data in our 90% interval, but we also wouldn’t expect to,
and as none of our priors are uniform, we are not closing off the
possibility that the posteriors could be wider.</p>
</section>
<section id="metropolis-hastings">
<h5>Metropolis-Hastings<a class="headerlink" href="#metropolis-hastings" title="Link to this heading">#</a></h5>
<p>To implement the Metropolis-Hastings algorithm, we’ll start by writing
functions to compute the log-posterior of the probability model.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">log_prior</span><span class="p">(</span><span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">Kq</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">Ks</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.003</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">Alp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">Huz</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lp</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_likelihood</span><span class="p">(</span><span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="p">):</span>
    <span class="n">hymod_out</span> <span class="o">=</span> <span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">hymod</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="o">=</span><span class="n">ndays</span><span class="p">)[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">leaf_data</span><span class="p">[</span><span class="s1">&#39;Strmflw&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hymod_out</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span> <span class="c1"># compute residuals</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ll</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_posterior</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">leaf_data</span><span class="o">=</span><span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="o">=</span><span class="mi">4015</span><span class="p">):</span>
    <span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">log_prior</span><span class="p">(</span><span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="c1"># only evaluate the model if the log-prior &gt; -Inf</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">Kq</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">Alp</span><span class="p">,</span> <span class="n">Huz</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="p">)</span>
        <span class="n">lp</span> <span class="o">+=</span> <span class="n">ll</span>
    <span class="k">return</span> <span class="n">lp</span>
</pre></div>
</div>
<p>Next, we’ll implement the Metropolis-Hastings algorithm. The number of
iterations is set to 100,000, which is needed for convergence. The
<code class="docutils literal notranslate"><span class="pre">metropolis()</span></code> function may take a long time to run (75-290 min), to
speed this up, reduce the <code class="docutils literal notranslate"><span class="pre">niter</span></code> parameter (ex. <code class="docutils literal notranslate"><span class="pre">niter</span> <span class="pre">=</span> <span class="pre">1000</span></code>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">niter</span> <span class="o">=</span> <span class="mi">100000</span>

<span class="n">init_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]])</span>
<span class="n">proposal_sd</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="n">metropolis</span><span class="p">(</span><span class="n">niter</span><span class="p">,</span> <span class="n">proposal_sd</span><span class="p">,</span> <span class="n">init_params</span><span class="p">,</span> <span class="n">log_posterior</span><span class="p">)</span>
</pre></div>
</div>
<p>What is the acceptance rate? Both too high and too low of an acceptance
rate suggest something is off with how our sampler is balancing
exploration and exploitation. The theoretical “ideal” is between 24-45%.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.27565</span>
</pre></div>
</div>
<p>To provide some evidence for convergence, let’s look at the traceplots.
We’ll look at a burn-in of 1/10 the number of iterations; this may need
to change depending on the number of iterations you run (e.g. if the
traceplot after the red vertical line appears to shift versus appearing
roughly stationary for the rest of the chain).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Kq&quot;</span><span class="p">,</span> <span class="s2">&quot;Ks&quot;</span><span class="p">,</span> <span class="s2">&quot;Alp&quot;</span><span class="p">,</span> <span class="s2">&quot;Huz&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
<span class="n">nburn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">niter</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">nburn</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="c1"># modify x to look at other burnin lengths</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">);</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_37_1.png" src="_images/mcmc_37_1.png" />
</figure>
<p>We can see that we might have converged by 10,000 iterations (or
possibly earlier). We will discard the samples from before this point as
burn-in since they have an unrepresentative probability in the sampled
chain.</p>
<p>Let’s zoom in on the samples from after this point.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">nburn</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">niter</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">);</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_39_1.png" src="_images/mcmc_39_1.png" />
</figure>
<p>These chains look like a “hairy caterpillar”, which is the ideal pattern
for the chain to mix well and sample systematically throughout the
posterior distribution. If our proposal distribution had been too
narrow, we would have accepted many more samples, but the traceplot
above would look like a narrow line “dragging” slowly, instead of
bouncing around (the chain for <span class="math notranslate nohighlight">\(K_s\)</span> looks closest to this type fo
behavior). If it had been too wide, we would have rejected many more
samples, and the traceplot would have looked more like a city skyline,
as the sampler would have gotten stuck at the same value for a long
time.</p>
<p>The chains shown above <em>look</em> roughly stationary: there is no visual
evidence of large shifts in the distribution, such as jumps or changes
in the variance. However, the only guarantee that the Markov chain
produced by the Metropolis-Hastings algorithm will converge to the
target distribution is asymptotic (as the number of iterations
<span class="math notranslate nohighlight">\(n \to \infty\)</span>), and there is no mathematically-guaranteed rate of
convergence to guide our decision-making. Instead, we generally want to
be skeptical that our chain has converged to the target distribution and
to accumulate evidence contradicting our skepticism.</p>
<p>One quick check for convergence is to look at whether the distribution
of samples change between the first half of the post-burn-in chain and
its entirety. If the second half of the samples do not materially change
the distribution, that is evidence for convergence, as it suggests that
the later samples are drawn from the same distribution as the earlier
ones. On the other hand, if the two distributions differ, the later
samples are clearly not drawn from the same distribution as the first
samples, and it would be unclear that the chain has converged.</p>
<p>Let’s implement this check for <span class="math notranslate nohighlight">\(K_q\)</span> as an example. We can see
from the figure below that the two histograms look roughly similar,
which passes this convergence check.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">nburn</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">niter</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">i</span><span class="p">],</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">nburn</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">niter</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Kq&quot;</span><span class="p">);</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">);</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Kq&quot;</span><span class="p">);</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">);</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_41_1.png" src="_images/mcmc_41_1.png" />
</figure>
<p>A more systematic generalization of this convergence check would involve
generating multiple chains starting at different initial conditions to
check that the chains reach roughly the same distribution, but we will
skip that for now.</p>
<p>Let’s look at the resulting parameter distributions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">nburn</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">niter</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">);</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_43_1.png" src="_images/mcmc_43_1.png" />
</figure>
<p>Now, let’s simulate from the posterior distribution to see how well we
capture the observed streamflow.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsamp</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">nburn</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">niter</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">nsamp</span><span class="p">)</span>

<span class="c1"># simulate</span>
<span class="n">hymod_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndays</span><span class="p">,</span> <span class="n">nsamp</span><span class="p">))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">hymod_sim</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">msdbook</span><span class="o">.</span><span class="n">hymod</span><span class="o">.</span><span class="n">hymod</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">leaf_data</span><span class="p">,</span> <span class="n">ndays</span><span class="o">=</span><span class="n">ndays</span><span class="p">)[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">ndays</span><span class="p">))</span>

<span class="c1"># compute quantiles</span>
<span class="n">hymod_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">hymod_sim</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">strmflw_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">),</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">Strmflw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">),</span> <span class="n">hymod_q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">),</span> <span class="n">hymod_q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">hymod_q</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">strmflw_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Observations&#39;</span><span class="p">,</span> <span class="s1">&#39;Posterior Predictive Median&#39;</span><span class="p">,</span> <span class="s1">&#39;90% Posterior Predictive Interval&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">);</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/mcmc_46_1.png" src="_images/mcmc_46_1.png" />
</figure>
<p>We can visually see that we fail to capture some of the extremes in the
90% projection interval. This is ok; we would expect about 10% of the
data to be outside of the interval if the model were well-calibrated. To
check, we can compute the <em>surprise index</em>, which is the fraction of
points outside of the projection interval.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">si</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">hymod_q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">leaf_data</span><span class="o">.</span><span class="n">Strmflw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hymod_q</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndays</span><span class="p">)])</span> <span class="o">/</span> <span class="n">ndays</span><span class="p">)</span>
<span class="n">si</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.09464508094645085</span>
</pre></div>
</div>
<p>The surprise index is 9.4%, when we would expect it to be 10%. That’s
not bad (actually, it’s quite good), and means that the model is well
calibrated. If we wanted to dial the calibration in further (or if the
surprise index were far off, like 20% or 2%), we could change the priors
to be more or less restrictive as appropriate. This is somewhat of a
judgement call; there is no objectively acceptable threshold for
deviation from the target calibration level, but in general, being
within a few percentage points is acceptable.</p>
</section>
</section>
<section id="challenges-and-next-steps">
<h4><span class="section-number">B.7.1.3. </span>Challenges and Next Steps<a class="headerlink" href="#challenges-and-next-steps" title="Link to this heading">#</a></h4>
<p>Two of the main challenges in implementing MCMC are:</p>
<ol class="arabic simple">
<li><p>The complexity of the model. As MCMC can take hundreds of thousands
of model evaluations, small increases in computational expense can be
the difference in whether MCMC is feasible or not. Increasing number
of un- or weakly-correlated parameters (model or statistical) can
also pose problems, as these require more samples to fully explore
and capture the distribution. Since the Metropolis-Hastings algorithm
in particular is fundamentally serial (the need to burn in every
chain means there is only a weak benefit to parallelization), these
challenges are to some degree unavoidable without the use of a more
sophisticated algorithm.</p></li>
<li><p>Selection of the proposal distribution. The efficiency of the sampler
makes a big difference in the number of needed samples and the
<em>effective sample size</em> of the resulting chain. This can require a
lot of tuning and gets more complex as the number of parameters
increases.</p></li>
<li><p>Specification of the likelihood/probability model. We used a fairly
simple model for the HYMOD residuals, but for more complex settings,
the residuals may exhibit a high degree of spatial or temporal
autocorrelation or may be highly nonstationary. Developing the model
and writing down the likelihood function for the error process may be
intractable for some classes of models.</p></li>
</ol>
<p>The first two challenges can be addressed with more advanced methods
than those used here. Adaptive Metropolis-Hastings algorithms (such as
those included in the <code class="docutils literal notranslate"><span class="pre">adaptMCMC</span></code> R package or <code class="docutils literal notranslate"><span class="pre">AdaptiveMCMC</span></code> in
Julia) automatically tune the proposal distribution based on the
acceptance rate. Much more powerful algorithms such as Hamiltonian Monte
Carlo (used in the Stan family of packages, <code class="docutils literal notranslate"><span class="pre">pyMC3</span></code> in Python, and
<code class="docutils literal notranslate"><span class="pre">Turing</span></code> in Julia) use information about the gradient of the posterior
to sample very efficiently, though this often requires the ability to
automatically differentiate external simulation models, which may or may
not always be possible.</p>
<p>The third challenge is more fundamental (and general) for uncertainty
quantifican. When writing down a likelihood function is intractable,
Approximate Bayesian Computation (ABC) is a likelihood-free approach which
is based on comparing summary statistics, rather than computing the
posterior density.</p>
</section>
<section id="tips-for-using-mcmc">
<h4><span class="section-number">B.7.1.4. </span>Tips for Using MCMC<a class="headerlink" href="#tips-for-using-mcmc" title="Link to this heading">#</a></h4>
<p>In this tutorial, we saw how to implement the Metropolis-Hastings
algorithm for HYMOD. In order to use Metropolis-Hastings or other MCMC
algorithms to your problem, you will need to answer the following
questions:</p>
<ol class="arabic simple">
<li><p>Do you have a probability model for the data-generating process? This
could be a statistical model for the data or a model for the
discrepancy between a simulation model and the data. We often begin
with a relatively simple model (<em>e.g.</em> normally-distributed
residuals) and add complexity based on whether residual diagnostics
suggest that the probability model was appropriate. If you do not or
cannot write down an appropriate probability model, you could look at
likelihood-free methods such as Approximate Bayesian Computation
(ABC).</p></li>
<li><p>How complex is your inference problem? The more computationally
complex your model or the higher the dimensionality of the parameter
space, the longer MCMC will need to run to fully sample from the
posterior distribution. If your model is too complex, you could begin
with initial uncertainty characterization or sensitivity analyses to
evaluate the extent to which dimension reduction is possible, and you
could look into emulation or surrogate modeling methods. Using
Hamiltonian Monte Carlo methods are also an option if your model is
amenable to automatic differentiation.</p></li>
<li><p>How important is parametric uncertainty for your problem? If you’re
only interested in a point estimate of parameters, you could more
directly optimize the posterior density to find the maximum <em>a
posteriori</em> estimate instead of sampling from the posterior
distribution.</p></li>
</ol>
<p>If your answers to these questions suggest that MCMC is tractable and
useful for your problem, you should feel free to experiment with the
HYMOD example, including the number of iterations, the probability model
specification, and the proposal distribution. Just be aware that
increasing the number of iterations or making the probability model more
complex might make the notebook take longer to run.</p>
</section>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="A1_Uncertainty_Quantification.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">1. </span>Uncertainty Quantification</p>
      </div>
    </a>
    <a class="right-next"
       href="A3_plotting_code.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Plotting Code Samples</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fishery-dynamics-tutorial">B.1. Fishery Dynamics Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-sensitivity-analysis-sa-to-discover-factors-shaping-consequential-dynamics">B.1.1. Tutorial: Sensitivity Analysis (SA) to discover factors shaping consequential dynamics</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lets-get-started">B.1.1.1. Let’s get started!</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-load-identified-solutions-and-explore-performance">B.1.1.2. Step 1: Load identified solutions and explore performance</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-use-salib-to-generate-a-sample-for-a-sobol-sensitivity-analysis">B.1.1.3. Step 2: Use SALib to generate a sample for a Sobol sensitivity analysis</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-evaluate-the-system-over-all-generated-states-of-the-world">B.1.1.4. Step 3: Evaluate the system over all generated states of the world</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-calculate-sensitivity-indices">B.1.1.5. Step 4: Calculate sensitivity indices</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-explore-relationship-between-uncertain-factors-and-performance">B.1.1.6. Step 5: Explore relationship between uncertain factors and performance</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-sobol-sa-and-scenario-discovery-to-your-problem">B.1.1.7. Tips to Apply Sobol SA and Scenario Discovery to your Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sobol-sa-tutorial">B.2. Sobol SA Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-sensitivity-analysis-sa-using-the-saltelli-sampling-scheme-with-sobol-sa">B.2.1. Tutorial: Sensitivity Analysis (SA) using the Saltelli sampling scheme with Sobol SA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">B.2.1.1. Let’s get started!</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-generate-the-problem-dictionary">B.2.1.2. Step 1: Generate the problem dictionary</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-generate-samples-using-the-saltelli-sampling-scheme">B.2.1.3. Step 2: Generate samples using the Saltelli sampling scheme</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-execute-the-ishigami-function-over-our-sample-set">B.2.1.4. Step 3: Execute the Ishigami function over our sample set</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-compute-first-second-and-total-order-sensitivity-indices-using-the-sobol-method">B.2.1.5. Step 4: Compute first-, second-, and total-order sensitivity indices using the Sobol method</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-interpret-our-results">B.2.1.6. Step 5: Interpret our results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-sobol-sa-to-your-own-problem">B.2.1.7. Tips to Apply Sobol SA to Your Own Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-tutorial">B.3. Logistic Regression Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-logistic-regression-for-factor-mapping">B.3.1. Tutorial: Logistic Regression for Factor Mapping</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#background">B.3.1.1. Background</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">B.3.1.2. Let’s get started!</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-load-latin-hypercube-sample-and-set-up-problem">B.3.1.3. Step 1: Load Latin hypercube sample and set up problem</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-define-decision-relevant-metrics-for-illustration">B.3.1.4. Step 2: Define decision-relevant metrics for illustration</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-run-the-logistic-regression">B.3.1.5. Step 3: Run the logistic regression</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-factor-ranking">B.3.1.6. Step 4: Factor ranking</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-draw-factor-maps">B.3.1.7. Step 5: Draw factor maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-scenario-discovery-to-your-own-problem">B.3.1.8. Tips to Apply Scenario Discovery to Your Own Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hymod-dynamics-tutorial">B.4. HYMOD Dynamics Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-sensitivity-analysis-of-the-hymod-model">B.4.1. Tutorial: Sensitivity Analysis of the HYMOD Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-hymod">B.4.2. 1 - Introduction to HYMOD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-sensitivity-analysis">B.4.3. 2- Global Sensitivity Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-apply-this-methodology-to-your-own-problem">B.4.4. Tips to Apply this methodology to your own problem</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#time-evolving-scenario-discovery-for-infrastructure-pathways">B.5. Time-evolving scenario discovery for infrastructure pathways</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">B.5.1. Time-evolving scenario discovery for infrastructure pathways</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">B.5.1.1. Background</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-robustness-over-time">B.5.1.2. Evaluating Robustness over time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-performance-evolution">B.5.1.3. Exploring performance evolution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-deep-uncertainties-generate-vulnerability">B.5.1.4. How do deep uncertainties generate vulnerability</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#which-uncertainties-have-the-most-influence-on-time-evolving-performance">B.5.1.5. Which uncertainties have the most influence on time-evolving performance?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#open-exploration">B.5.1.6. Open exploration</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">B.5.1.7. Tips to apply this methodology to your own problem</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#references">B.5.1.8. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios-tutorial">B.6. A Hidden-Markov Modeling Approach to Creating Synthetic Streamflow Scenarios Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios">B.6.1. A Hidden-Markov Modeling Approach to Creating Synthetic Streamflow Scenarios</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">B.6.1.1. Background</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">B.6.2. Let’s Get Started!</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#observed-record">B.6.2.1. Observed Record</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-stationary-generator-to-better-quantify-natural-variability">B.6.2.2. Synthetic Stationary Generator to Better Quantify Natural Variability</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#non-stationary-synthetic-generator-to-impose-climate-changes">B.6.2.3. Non-Stationary Synthetic Generator to Impose Climate Changes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#placing-cmip5-projections-in-the-context-of-non-stationary-flows">B.6.2.4. Placing CMIP5 Projections in the Context of Non-Stationary Flows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-to-create-an-hmm-based-generator-for-your-system">B.6.2.5. Tips to Create an HMM-Based Generator for your System</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">B.6.2.6. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-calibration-with-markov-chain-monte-carlo-tutorial">B.7. Model Calibration with Markov chain Monte Carlo Tutorial</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-calibration-with-markov-chain-monte-carlo">B.7.1. Model Calibration with Markov chain Monte Carlo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mcmc-for-model-calibration-and-uncertainty-quantification">B.7.1.1. MCMC for Model Calibration and Uncertainty Quantification</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-uncertainty-quantification">Bayesian Uncertainty Quantification</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#rejection-sampling">Rejection Sampling</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#markov-chain-monte-carlo">Markov chain Monte Carlo</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hymod-calibration">B.7.1.2. HYMOD Calibration</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-distributions">Prior Distributions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#metropolis-hastings">Metropolis-Hastings</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#challenges-and-next-steps">B.7.1.3. Challenges and Next Steps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tips-for-using-mcmc">B.7.1.4. Tips for Using MCMC</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-current, Battelle Memorial Institute.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>